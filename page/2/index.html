<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="V4mjId6JYX7o1j4L14DFN6f6g6BnrPuhGEUruFm4_uQ">








  <meta name="baidu-site-verification" content="XMpGgFHb0u">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="薛亮的主页">
<meta property="og:url" content="http://blog.xueliang.org/page/2/index.html">
<meta property="og:site_name" content="薛亮的主页">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="薛亮的主页">






  <link rel="canonical" href="http://blog.xueliang.org/page/2/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>薛亮的主页</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-79734225-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-79734225-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5421679576a468e7d0721da69c6e18aa";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">薛亮的主页</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2017/03/26/MySQL-多列索引优化小记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/26/MySQL-多列索引优化小记/" itemprop="url">
                  MySQL 多列索引优化小记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-26 15:56:31" itemprop="dateCreated datePublished" datetime="2017-03-26T15:56:31+08:00">2017-03-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 20:09:32" itemprop="dateModified" datetime="2018-12-01T20:09:32+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/26/MySQL-多列索引优化小记/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/26/MySQL-多列索引优化小记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/26/MySQL-多列索引优化小记/" class="leancloud_visitors" data-flag-title="MySQL 多列索引优化小记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>MySQL 5.6.30</p>
</blockquote>
<h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>由于爬虫抓取的数据不断增多，这两天在不断对数据库以及查询语句进行优化，其中一个表结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `newspaper_article` (</span><br><span class="line">  `id` varchar(50) NOT NULL COMMENT &apos;编号&apos;,</span><br><span class="line">  `title` varchar(190) NOT NULL COMMENT &apos;标题&apos;,</span><br><span class="line">  `author` varchar(255) DEFAULT NULL COMMENT &apos;作者&apos;,</span><br><span class="line">  `date` date NULL DEFAULT NULL COMMENT &apos;发表时间&apos;,</span><br><span class="line">  `content` longtext COMMENT &apos;正文&apos;,</span><br><span class="line">  `status` tinyint(4) DEFAULT &apos;0&apos;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `idx_status_date` (`status`,`date`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;文章表&apos;;</span><br></pre></td></tr></table></figure></p>
<p>根据业务需要，添加了 <code>idx_status_date</code> 索引，在执行下面这个 SQL 时特别耗时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id, title, status, date FROM newspaper_article WHERE status &gt; -2 AND date = &apos;2016-01-07&apos;;</span><br></pre></td></tr></table></figure></p>
<p>根据观察，每天新增的数据大概在2500条以内，本以为这里指定了具体某天的日期 <code>&#39;2016-01-07&#39;</code> ，实际需要扫描的数据量应该在2500条以内才对，但实际并非如此：<br><img src="http://image.xueliang.org/Fk93L0VL2P4oXlfqm3heVGId_z-J" alt="EXPLAIN"><br>实际共扫描了185589条数据，远远高于预估的2500条，且实际执行时间都将近3秒钟：</p>
<p><img src="http://image.xueliang.org/FiDBpGkTmeMhahJnOl8np9g-8xu_" alt="EXPLAIN"></p>
<p>这是为什么呢？</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>将 <code>idx_status_date (status, date)</code> 改为 <code>idx_status (status)</code> 后，查看 MySQL 执行计划：</p>
<p><img src="http://image.xueliang.org/FjU1K2BW5hE-Q2RRe8qjbOgp2_ti" alt="EXPLAIN"></p>
<p>可以看到将多列索引改为单列索引后，执行计划要扫描的数据总量没有任何变化。结合多列索引遵循最左前缀原则，推测上面的查询语句只使用了 <code>idx_status_date</code> 最左边的 <code>status</code> 的索引。</p>
<p>翻了下《高性能MySQL》找到了下面这段话，证实了我的想法：</p>
<blockquote>
<p>如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。例如有查询 <code>WHERE last_name = &#39;Smith&#39; AND first_name LIKE &#39;J%&#39; AND dob = &#39;1976-12-23&#39;</code> ，这个查询只能使用索引的前两列，因为这里 <code>LIKE</code> 是一个范围条件（但是服务器可以把其余列用于其他目的）。如果范围查询列值的数量有限，那么可以通过使用多个等于条件来代替范围条件。</p>
</blockquote>
<p>因此，这里解决思路有两种：</p>
<ul>
<li>可以通过使用多个等于条件来代替范围条件</li>
<li>修改 <code>idx_status_date (status, date)</code> 为索引 <code>idx_date_status (date, status)</code> ，并新建一个 <code>idx_status</code> 索引，即可达到同样的效果。</li>
</ul>
<p>优化后的执行计划：</p>
<p><img src="http://image.xueliang.org/Fk174VOrEpgCc9Aw7sDe95xlg8cs" alt="EXPLAIN"></p>
<p>实际执行结果：</p>
<p><img src="http://image.xueliang.org/Fif7-uOlq8mLBm4wwRF4FTbRUAvV" alt="EXPLAIN"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>当人们谈论索引的时候，如果没有特别指明类型，那么多半说的是 <code>B-Tree</code> 索引，它使用 <code>B-Tree</code> 数据结构来存储数据。我们使用术语“B-Tree”，是因为 MySQL 在 <code>CREATE TABLE</code> 和其他语句中也使用该关键字。不过，底层的存储引擎也可能使用不同的存储结构。InnoDB使用的是B+Tree。<br>假如有如下数据表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE People (</span><br><span class="line">  last_name  varchar(50)    not null,</span><br><span class="line">  first_name varchar(50)    not null,</span><br><span class="line">  dob        date           not null,</span><br><span class="line">  gender     enum(&apos;m&apos;, &apos;f&apos;) not null,</span><br><span class="line">  key(last_name, first_name, dob)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<h2 id="B-Tree-索引对如下类型的查询有效"><a href="#B-Tree-索引对如下类型的查询有效" class="headerlink" title="B-Tree 索引对如下类型的查询有效"></a>B-Tree 索引对如下类型的查询有效</h2><ul>
<li>全值匹配<br>全值匹配指的是和索引中的所有列进行匹配，例如上表的索引可用于查找姓名为 Cuba Allen 、出生于 1960-01-01 的人。</li>
<li>匹配最左前缀<br>上表中的索引可用于查找所有姓为 Allen 的人，即只使用索引的第一列。</li>
<li>匹配列前缀<br>只匹配某一列的值的开头部分。例如上表的索引可用于查找所有以 J 开头的姓的人。这里也只使用了索引的第一列。</li>
<li>匹配范围值<br>例如上表中的索引可用于查找姓在 Allen 和 Barrymore 之间的人。这里也只使用了索引的第一列。</li>
<li>精确匹配某一列并范围匹配另外一列<br>上表的索引也可用于查找所有姓为 Allen ，并且名字是字母 K 开头（比如 Kim 、 Karl 等）的人。即第一列 last_name 全匹配，第二列 first_name 范围匹配。</li>
<li>只访问索引的查询<br>B-Tree 通常可以支持“只访问索引的查询”，即查询只需要访问索引，而无须访问数据行。</li>
</ul>
<h2 id="B-Tree-索引的一些限制"><a href="#B-Tree-索引的一些限制" class="headerlink" title="B-Tree 索引的一些限制"></a>B-Tree 索引的一些限制</h2><ul>
<li>如果不是按照索引的最左列开始查找，则无法使用索引。例如上表的索引无法用于查找名字为 Bill 的人，也无法查找某个特定生日的人，因为这两列都不是最左数据列。类似地，也无法查找姓氏以某个字母结尾的人。</li>
<li>不能跳过索引中列。也就是说，上表的索引无法用于查找姓氏为 Smith 并且在某个特定日期出生的人。如果不指定名（first_name），则 MySQL 只能使用索引的第一列。</li>
<li>如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。例如有查询 <code>WHERE last_name = &#39;Smith&#39; AND first_name LIKE &#39;J%&#39; AND dob = &#39;1976-12-23&#39;</code> ，这个查询只能使用索引的前两列，因为这里 <code>LIKE</code> 是一个范围条件（但是服务器可以把其余列用于其他目的）。如果范围查询列值的数量有限，那么可以通过使用多个等于条件来代替范围条件。</li>
</ul>
<h1 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h1><ul>
<li><a href="20160925012806814">MySQL 中 AUTO_INCREMENT 的“坑”</a></li>
<li><a href="20160805180325276">MySQL主从架构配置详解</a></li>
<li><a href="20160725154157065">MySQL中字符串、日期时间等常用函数总结</a></li>
<li><a href="3">MySQL 工作笔记（持续更新）</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2017/03/06/Spring-MVC-Security-4-初体验（Java配置版）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/06/Spring-MVC-Security-4-初体验（Java配置版）/" itemprop="url">
                  Spring MVC + Security 4 初体验（Java配置版）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-06 00:40:40" itemprop="dateCreated datePublished" datetime="2017-03-06T00:40:40+08:00">2017-03-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 22:58:25" itemprop="dateModified" datetime="2018-12-01T22:58:25+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/06/Spring-MVC-Security-4-初体验（Java配置版）/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/06/Spring-MVC-Security-4-初体验（Java配置版）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/06/Spring-MVC-Security-4-初体验（Java配置版）/" class="leancloud_visitors" data-flag-title="Spring MVC + Security 4 初体验（Java配置版）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>spring Version = 4.3.6.RELEASE<br>springSecurityVersion = 4.2.1.RELEASE<br>Gradle 3.0 + Eclipse Neno(4.6)</p>
</blockquote>
<p>这篇文章同样是使用的Java配置，而非XML配置，如果你对于Java配置的Spring MVC开发还不太熟悉，可以先看我<a href="http://xueliang.org/article/detail/20161102173458963" target="_blank" rel="noopener">这篇文章</a>。</p>
<h1 id="Authority"><a href="#Authority" class="headerlink" title="Authority"></a>Authority</h1><p>创建一个 <code>Authority</code> ，实现自 <code>org.springframework.security.core.GrantedAuthority</code> 类，<code>getAuthority</code> 方法只返回一个表示权限名称的字符串，如 <code>AUTH_USER</code> 、 <code>AUTH_ADMIN</code> 、 <code>AUTH_DBA</code> 等。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Authority implements GrantedAuthority &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    private String authority;</span><br><span class="line"></span><br><span class="line">    public Authority() &#123;  &#125;</span><br><span class="line">    public Authority(String authority) &#123;</span><br><span class="line">        this.setAuthority(authority);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getAuthority() &#123;</span><br><span class="line">        return this.authority;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAuthority(String authority) &#123;</span><br><span class="line">        this.authority = authority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="User"><a href="#User" class="headerlink" title="User"></a>User</h1><p><code>User</code> 类实现自 <code>org.springframework.security.core.userdetails.UserDetails</code> 接口，包含一组权限的集合 <code>authorities</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public class User implements UserDetails &#123;</span><br><span class="line">    </span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    </span><br><span class="line">    private String username;</span><br><span class="line">    private String password;</span><br><span class="line">    private List&lt;Authority&gt; authorities;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsername(String username) &#123;</span><br><span class="line">        this.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String getPassword() &#123;</span><br><span class="line">        return password;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setPassword(String password) &#123;</span><br><span class="line">        this.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        return this.authorities;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAuthorities(List&lt;Authority&gt; authorities) &#123;</span><br><span class="line">        this.authorities = authorities;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean isAccountNonExpired() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isAccountNonLocked() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean isCredentialsNonExpired() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isEnabled() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h1><p><code>MyUserDetailsService</code> 实现了 <code>org.springframework.security.core.userdetails.UserDetailsService</code> 的 <code>loadUserByUsername</code> 方法，该方法根据用户名查询符合条件的用户，若没有找到符合条件的用户，必须抛出 <code>UsernameNotFoundException</code> 异常，而不能返回空。这里可以调用 DAO 层，从数据库查询用户，我为了简单，直接将用户临时放到一个常量内，模拟从数据库查询用户。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class MyUserDetailsService implements UserDetailsService &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">        List&lt;User&gt; userList = Constants.userList;</span><br><span class="line">        for (int i = 0, len = userList.size(); i &lt; len; i++) &#123;</span><br><span class="line">            User user = userList.get(i);</span><br><span class="line">            if (user.getUsername().equals(username)) &#123;</span><br><span class="line">                return user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        throw new UsernameNotFoundException(&quot;用户不存在！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="SecurityConfig"><a href="#SecurityConfig" class="headerlink" title="SecurityConfig"></a>SecurityConfig</h1><p><code>SecurityConfig</code> 类继承 <code>org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</code>，<code>WebSecurityConfigurerAdapter</code> 提供了一些默认的配置，方便创建一个实例。</p>
<p>进入 <code>configure</code> 方法中，首先允许任何情况下的对<code>csrfTokenApi</code> 的请求，该 API 返回一个 <code>csrfToken</code> ，默认情况下除 <code>GET</code>、<code>HEAD</code>、<code>TRACE</code> 和 <code>OPTIONS</code>外，所有请求都必须经过 <a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0" target="_blank" rel="noopener">CSRF</a> 认证。接下来对不同的API请求设置不同的权限，并且确保所有对 <code>/api/</code> 下的请求都经过了认证。<br>这里向 <code>access</code> 方法传递的表达式中的权限名称，对应上面提到的 <code>Authority</code> 类中 <code>getAuthority</code> 返回的字符串的值，详细的表达式介绍，请移步至<a href="http://docs.spring.io/spring-security/site/docs/4.2.2.RELEASE/reference/htmlsingle/#el-access" target="_blank" rel="noopener">这里</a>。</p>
<p>接着，对登录表单进行配置。通过 <code>loginProcessingUrl</code> 配置表单提交地址，这个地址对应的API不需要自己写，Spring Security 会自动拦截提交到此地址请求，将其视为登录请求。如果希望登录成功后通过服务器转发到其他页面，可以调用 <code>successForwardUrl(String forwardUrl)</code> 方法指定跳转的地址，对应地，指定失败后跳转地址的方法是 <code>failureForwardUrl(String forwardUrl)</code>。</p>
<p>这里我使用了RESTful，故不需要配置服务端的转发，而是配置了另外两处：<code>successHandler</code> 和 <code>failureHandler</code> ，<code>successHandler</code> 方法接收一个 <code>AuthenticationSuccessHandler</code> 对象，认证通过之后，Spring Security 将调用该对象的 <code>onAuthenticationSuccess</code> 方法，类似地，<code>failureHandler</code> 方法接收一个 <code>AuthenticationFailureHandler</code> 对象，认证失败之后，将调用该对象的 <code>onAuthenticationFailure</code> 方法。</p>
<p>配置完登录相关信息之后，接着配置和登出有关的信息。和配置登录表单提交地址类似，这里需要配置登出请求提交地址，这里调用 <code>logoutUrl</code> 方法，指定登出的链接地址，该地址和前面提到的 <code>loginProcessingUrl</code> 都不需要自己写，这两个都是全权交由 Spring Security 来处理。当用户请求 <code>logoutUrl</code> 方法指定的地址时，Spring Security 将对用户执行登出操作。和前面提到的 <code>successForwardUrl</code> 类似，这里提供了 <code>logoutSuccessUrl</code> 方法指定登出成功之后转发的地址。不过我用了RESTful，就不再调用此方法，而是调用 <code>logoutSuccessHandler</code> 传入 <code>LogoutSuccessHandler</code> 对象，登出成功后将调用该对象的 <code>onLogoutSuccess</code> 方法。</p>
<p>最后，配置对异常的处理 <code>exceptionHandling</code> ，和上面介绍的 <code>successHandler</code> 、 <code>failureHandler</code> 以及 <code>logoutSuccessHandler</code> 差不多，<code>authenticationEntryPoint</code> 接收一个 <code>AuthenticationEntryPoint</code> 对象，当用户请求的操作需要登录时，将抛出 <code>AuthenticationException</code> 异常，并且将该异常传入到 <code>AuthenticationEntryPoint</code> 对象的 <code>commence</code> 方法。<br><code>accessDeniedHandler</code> 方法接收一个 <code>AccessDeniedHandler</code> 对象，该对象的 <code>handle</code> 方法将在权限不足时调用。</p>
<p>配置完这些，看 <code>configureGlobalSecurity</code> 方法，给 <code>AuthenticationManagerBuilder</code> 配置一个 <code>UserDetailsService</code> 对象，当用户执行登录时，Spring Security 将调用该对象的 <code>loadUserByUsername</code> 方法，将 <code>username</code> 传入此方法，根据 <code>username</code> 获取一个 <code>UserDetails</code> 对象。</p>
<p>另外，由于不能在数据库中保存明文密码，这里对密码进行 <code>bcrypt</code> 加密后保存，验证密码是否正确时，需要对用户输入的明文密码进行 <code>bcrypt</code> 加密后比较密文是否一致，故这里需要提供一个 <code>BCryptPasswordEncoder</code> 对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;api.csrftoken&#125;&quot;)</span><br><span class="line">    private String csrfTokenApi;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;api.login&#125;&quot;)</span><br><span class="line">    private String loginApi;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;api.logout&#125;&quot;)</span><br><span class="line">    private String logoutApi;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private PasswordEncoder passwordEncoder;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http.authorizeRequests().antMatchers(csrfTokenApi).permitAll()</span><br><span class="line">        .antMatchers(&quot;/api/user/**&quot;).access(&quot;hasAuthority(&apos;USER&apos;)&quot;)</span><br><span class="line">        .antMatchers(&quot;/api/admin/**&quot;).access(&quot;hasAuthority(&apos;ADMIN&apos;)&quot;)</span><br><span class="line">        .antMatchers(&quot;/api/dba/**&quot;).access(&quot;hasAuthority(&apos;DBA&apos;)&quot;)</span><br><span class="line">        .antMatchers(&quot;/api/**&quot;).fullyAuthenticated()</span><br><span class="line">        .and().formLogin().loginProcessingUrl(loginApi)</span><br><span class="line">        .successHandler(new RestAuthenticationSuccessHandler())</span><br><span class="line">        .failureHandler(new RestAuthenticationFailureHandler())</span><br><span class="line">        .and().logout().logoutUrl(logoutApi)</span><br><span class="line">        .logoutSuccessHandler(new RestLogoutSuccessHandler())</span><br><span class="line">        .and().exceptionHandling().authenticationEntryPoint(new RestAuthenticationEntryPoint())</span><br><span class="line">        .accessDeniedHandler(new RestAccessDeniedHandler());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    public void configureGlobalSecurity(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder(11);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="WebAppConfig"><a href="#WebAppConfig" class="headerlink" title="WebAppConfig"></a>WebAppConfig</h1><p>因为采用RESTful风格，这里配置响应视图为json格式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableWebMvc</span><br><span class="line">@ComponentScan(basePackages = &quot;org.xueliang.springsecuritystudy&quot;)</span><br><span class="line">@PropertySource(&#123;&quot;classpath:config.properties&quot;&#125;)</span><br><span class="line">public class WebAppConfig extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public RequestMappingHandlerAdapter requestMappingHandlerAdapter(@Autowired MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter, @Autowired ContentNegotiationManager mvcContentNegotiationManager) &#123;</span><br><span class="line">        RequestMappingHandlerAdapter requestMappingHandlerAdapter = new RequestMappingHandlerAdapter();</span><br><span class="line">        requestMappingHandlerAdapter.setMessageConverters(Collections.singletonList(mappingJackson2HttpMessageConverter));</span><br><span class="line">        requestMappingHandlerAdapter.setContentNegotiationManager(mvcContentNegotiationManager);</span><br><span class="line">        return requestMappingHandlerAdapter;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter() &#123;</span><br><span class="line">        return new MappingJackson2HttpMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * 设置欢迎页</span><br><span class="line">     * 相当于web.xml中的 welcome-file-list &gt; welcome-file</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void addViewControllers(ViewControllerRegistry registry) &#123;</span><br><span class="line">        registry.addRedirectViewController(&quot;/&quot;, &quot;/index.html&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="WebAppInitializer"><a href="#WebAppInitializer" class="headerlink" title="WebAppInitializer"></a>WebAppInitializer</h1><p>Spring Security 架构是完全基于标准的 Servlet 过滤器的，这里我们需要在 <code>WebInitializer</code> 中引入 <code>DelegatingFilterProxy</code> 过滤器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class WebAppInitializer extends AbstractAnnotationConfigDispatcherServletInitializer &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onStartup(ServletContext servletContext) throws ServletException &#123;</span><br><span class="line">        servletContext.addFilter(&quot;springSecurityFilterChain&quot;, new DelegatingFilterProxy(&quot;springSecurityFilterChain&quot;)).addMappingForUrlPatterns(null, false, &quot;/api/*&quot;);</span><br><span class="line">        // 静态资源映射</span><br><span class="line">        servletContext.getServletRegistration(&quot;default&quot;).addMapping(&quot;*.html&quot;, &quot;*.ico&quot;);</span><br><span class="line">        super.onStartup(servletContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        return new Class[] &#123; WebAppConfig.class &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected String[] getServletMappings() &#123;</span><br><span class="line">        return new String[] &#123; &quot;/&quot; &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Filter[] getServletFilters() &#123;</span><br><span class="line">        return new Filter[] &#123; new CharacterEncodingFilter(&quot;UTF-8&quot;, true) &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h1><p>本文使用到的项目源码已经放到 <a href="https://github.com/liangzai-cool/springsecuritystudy" target="_blank" rel="noopener">Github</a> 上，你可以下载后运行。</p>
<h1 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h1><ul>
<li><a href="20161102173458963">Spring RESTful + Redis全注解实现恶意登录保护机制</a></li>
<li><a href="20170116145848852">Java程序通过代理访问网络</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2017/01/16/Java程序通过代理访问网络/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/16/Java程序通过代理访问网络/" itemprop="url">
                  Java程序通过代理访问网络
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-01-16 06:58:49" itemprop="dateCreated datePublished" datetime="2017-01-16T06:58:49+08:00">2017-01-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 19:50:03" itemprop="dateModified" datetime="2018-12-01T19:50:03+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/16/Java程序通过代理访问网络/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/16/Java程序通过代理访问网络/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/01/16/Java程序通过代理访问网络/" class="leancloud_visitors" data-flag-title="Java程序通过代理访问网络">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>最近工作上有开发爬虫的任务，对目标网站数据进行抓取，由于大部分网站都在国外，无法直接访问，需要通过代理才能登录。爬虫部署的服务器在香港，所以爬虫部署到服务器后，是可以访问目标网站的，但本地开发调试程序时，需要通过代理才能访问。<br>这篇文章就带大家了解一下如何在Java程序中使用代理访问网络。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ul>
<li><p>你需要一个代理服务器，和一个可以连接到此服务器的客户端。<br>  花点银子买一个稳定的账号，或者自己搭建一个。<br>  这里我使用自己搭建的 <code>Shadowsocks</code> 代理服务器，使用 <code>Shadowsocks-Windows</code> 作为本地代理的客户端，并开启默认的 <code>1080</code> 端口，以供本地其他程序通过代理访问网络。<br>  <img src="http://image.xueliang.org/FqlRARvFIf1lKIBlLvEz4ay5L9ko" alt="编辑服务器信息"></p>
</li>
<li><p>指定 Java 程序的代理服务器地址和端口<br>有两种指定方式：</p>
<ol>
<li><p>通过 命令行参数 指定<br>如果只需要考虑代理 HTTP 协议请求，只需添加如下命令行参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=1080</span><br></pre></td></tr></table></figure>
<p>想要 HTTP 和 HTTPS 协议的请求都通过代理访问网络，可以追加上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dhttps.proxyHost=127.0.0.1 -Dhttps.proxyPort=1080</span><br></pre></td></tr></table></figure>
<p>最终填写的值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=1080 -Dhttps.proxyHost=127.0.0.1 -Dhttps.proxyPort=1080</span><br></pre></td></tr></table></figure>
</li>
<li><p>在程序中使用System.setProperty(String, String)<br>同样很简单，这里直接上代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String proxyHost = &quot;127.0.0.1&quot;;</span><br><span class="line">String proxyPort = &quot;1080&quot;;</span><br><span class="line">      </span><br><span class="line">System.setProperty(&quot;http.proxyHost&quot;, proxyHost);</span><br><span class="line">System.setProperty(&quot;http.proxyPort&quot;, proxyPort);</span><br><span class="line">      </span><br><span class="line">// 对https也开启代理</span><br><span class="line">System.setProperty(&quot;https.proxyHost&quot;, proxyHost);</span><br><span class="line">System.setProperty(&quot;https.proxyPort&quot;, proxyPort);</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<p>推荐使用第一种方案，通过VM Option 的方式，对代码没有任何侵入，绿色环保。</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>这里我在Eclipse中使用第一种方法进行测试。</p>
<ul>
<li><p>测试代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.net.URLConnection;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        URL url = new URL(&quot;https://google.com&quot;);</span><br><span class="line">        URLConnection connection = url.openConnection();</span><br><span class="line">        connection.connect();</span><br><span class="line">        InputStream inputStream = connection.getInputStream();</span><br><span class="line">        byte[] bytes = new byte[1024];</span><br><span class="line">        while (inputStream.read(bytes) &gt;= 0) &#123;</span><br><span class="line">            System.out.println(new String(bytes));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试结果，可以正常访问Google等网站。<br><img src="http://image.xueliang.org/FlyRc6E_wFM5VPBDT4bHO7Tjuctv" alt="Java通过代理访问google.com结果"></p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>除了上述 <code>http.proxyHost</code> 和 <code>http.proxyPort</code>，以及 <code>https.proxyHost</code> 和 <code>https.proxyPort</code> 在代理时比较有用外，还有一个属性也比较有用，那就是 <code>http.nonProxyHosts</code>，它用来指定哪些主机不使用代理，如果有多个，用英文竖线（<code>|</code>）分隔，可以使用星号 （<code>*</code>）作为通配符。<br>下表是常用协议对应的代理属性：</p>
<table class="table table-bordered"><br>  <thead><br>    <th>协议</th><br>    <th>属性（代理主机/代理端口/不使用代理的主机列表）</th><br>    <th>默认值</th><br>  </thead><br>  <tbody><br>    <tr><br>      <td rowspan="3" style="vertical-align: middle;">HTTP</td><br>      <td>http.proxyHost</td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td>http.proxyPort</td><br>      <td>80</td><br>    </tr><br>    <tr><br>      <td>http.nonProxyHosts </td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td rowspan="3" style="vertical-align: middle;">HTTPS</td><br>      <td>https.proxyHost</td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td>https.proxyPort</td><br>      <td>443</td><br>    </tr><br>    <tr><br>      <td>https.nonProxyHosts </td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td rowspan="3" style="vertical-align: middle;">FTP</td><br>      <td>ftp.proxyHost</td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td>ftp.proxyPort</td><br>      <td>80</td><br>    </tr><br>    <tr><br>      <td>ftp.nonProxyHosts </td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td rowspan="3" style="vertical-align: middle;">SOCKS</td><br>      <td>socksProxyHost</td><br>      <td>&lt;none&gt;</td><br>    </tr><br>    <tr><br>      <td>socksProxyPort </td><br>      <td>1080</td><br>    </tr><br>  </tbody><br></table>

<p>详细介绍请参考官方说明：<a href="http://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html" target="_blank" rel="noopener">Java Networking and Proxies</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/11/02/Spring-RESTful-Redis全注解实现恶意登录保护机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/02/Spring-RESTful-Redis全注解实现恶意登录保护机制/" itemprop="url">
                  Spring RESTful + Redis全注解实现恶意登录保护机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-02 09:35:00" itemprop="dateCreated datePublished" datetime="2016-11-02T09:35:00+08:00">2016-11-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 20:14:09" itemprop="dateModified" datetime="2018-12-01T20:14:09+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/02/Spring-RESTful-Redis全注解实现恶意登录保护机制/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/11/02/Spring-RESTful-Redis全注解实现恶意登录保护机制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/11/02/Spring-RESTful-Redis全注解实现恶意登录保护机制/" class="leancloud_visitors" data-flag-title="Spring RESTful + Redis全注解实现恶意登录保护机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>好久没更博了…<br>最近看了个真正全注解实现的 SpringMVC 博客，感觉很不错，终于可以彻底丢弃 <code>web.xml</code> 了。其实这玩意也是老东西了，丢弃 <code>web.xml</code>，是基于 5、6年前发布的 Servlet 3.0 规范，只不过少有人玩而已…现在4.0都快正式发布了…Spring对注解的支持也从09年底就开始支持了…<br>基础部分我就不仔细讲了，可以先看一下<a href="https://my.oschina.net/devleon/blog/530803" target="_blank" rel="noopener">这篇</a> 以及其中提到的另外两篇文章，这三篇文章讲的很不错。<br>下面开始旧东西新玩~~~</p>
<h1 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h1><p>项目是基于 <code>gradle 3.1</code>构建的，这是项目依赖：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  <span class="keyword">def</span> springVersion = <span class="string">'4.3.2.RELEASE'</span></span><br><span class="line">  </span><br><span class="line">  compile <span class="string">"org.springframework:spring-web:$springVersion"</span></span><br><span class="line">  compile <span class="string">"org.springframework:spring-webmvc:$springVersion"</span></span><br><span class="line">  compile <span class="string">"redis.clients:jedis:2.9.0"</span></span><br><span class="line">  compile <span class="string">"javax.servlet:javax.servlet-api:3.1.0"</span></span><br><span class="line">  compile <span class="string">"org.json:json:20160810"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="编写Java版的web-xml"><a href="#编写Java版的web-xml" class="headerlink" title="编写Java版的web.xml"></a>编写Java版的web.xml</h1><p>想要让请求经过Java，少不了配置 <code>web.xml</code>，不过现在我们来写个Java版的~<br>这里和传统的 <code>web.xml</code> 一样，依次添加 <code>filter</code>， <code>servlet</code> 。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xueliang.loginsecuritybyredis.commons;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterRegistration;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRegistration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.WebApplicationInitializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CharacterEncodingFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.DispatcherServlet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于注解的/WEB-INF/web.xml</span></span><br><span class="line"><span class="comment"> * 依赖 servlet 3.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XueLiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2016年10月24日 下午5:58:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 基于注解配置的Web容器上下文</span></span><br><span class="line">		AnnotationConfigWebApplicationContext context = <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">		context.register(WebAppConfig.class);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 添加编码过滤器并进行映射</span></span><br><span class="line">		CharacterEncodingFilter characterEncodingFilter = <span class="keyword">new</span> CharacterEncodingFilter(<span class="string">"UTF-8"</span>, <span class="keyword">true</span>);</span><br><span class="line">		FilterRegistration.Dynamic dynamicFilter = servletContext.addFilter(<span class="string">"characterEncodingFilter"</span>, characterEncodingFilter);</span><br><span class="line">		dynamicFilter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">true</span>, <span class="string">"/*"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 添加静态资源映射</span></span><br><span class="line">		ServletRegistration defaultServletRegistration = servletContext.getServletRegistration(<span class="string">"default"</span>);</span><br><span class="line">		defaultServletRegistration.addMapping(<span class="string">"*.html"</span>);</span><br><span class="line">		</span><br><span class="line">		Servlet dispatcherServlet = <span class="keyword">new</span> DispatcherServlet(context);</span><br><span class="line">		ServletRegistration.Dynamic dynamicServlet = servletContext.addServlet(<span class="string">"dispatcher"</span>, dispatcherServlet);</span><br><span class="line">		dynamicServlet.addMapping(<span class="string">"/"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一步走完，Spring 基本上启动起来了。</p>
<h1 id="编写Java版的Spring配置"><a href="#编写Java版的Spring配置" class="headerlink" title="编写Java版的Spring配置"></a>编写Java版的Spring配置</h1><p>现在Spring已经可以正常启动了，但我们还要给 Spring 做一些配置，以便让它按我们需要的方式工作~<br>这里因为后端只负责提供数据，而不负责页面渲染，所以只需要配置返回 <code>json</code> 视图即可，个人比较偏爱采用内容协商，所以这里我使用了 <code>ContentNegotiationManagerFactoryBean</code>，但只配置了一个 JSON 格式的视图。<br>为了避免中文乱码，这里设置了 <code>StringHttpMessageConverter</code> 默认编码格式为 <code>UTF-8</code>，然后将其设置为 <code>RequestMappingHandlerAdapter</code> 的消息转换器。<br>最后还需要再配置一个欢迎页，类似于 <code>web.xml</code> 的 <code>welcome-file-list - welcome-file</code>，因为 Servlet 3.0 规范没有针对欢迎页的Java配置方案，所以目前只能在Java中这样配置，其效果类似于在XML版中配置 <code>&lt;mvc:redirect-view-controller path=&quot;/&quot; redirect-url=&quot;/index.html&quot;/&gt;</code> 。<br>最后注意这里的 <code>@Bean</code> 注解，默认的 <code>name</code> 是方法名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">package org.xueliang.loginsecuritybyredis.commons;</span><br><span class="line"></span><br><span class="line">import java.nio.charset.Charset;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.PropertySource;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.converter.StringHttpMessageConverter;</span><br><span class="line">import org.springframework.web.accept.ContentNegotiationManager;</span><br><span class="line">import org.springframework.web.accept.ContentNegotiationManagerFactoryBean;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line">import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter;</span><br><span class="line">import org.springframework.web.servlet.view.ContentNegotiatingViewResolver;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebMvc</span><br><span class="line">@ComponentScan(basePackages = &quot;org.xueliang.loginsecuritybyredis&quot;)</span><br><span class="line">@PropertySource(&#123;&quot;classpath:loginsecuritybyredis.properties&quot;&#125;)</span><br><span class="line">public class WebAppConfig extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 内容协商</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ContentNegotiationManager mvcContentNegotiationManager() &#123;</span><br><span class="line">	    ContentNegotiationManagerFactoryBean contentNegotiationManagerFactoryBean = new ContentNegotiationManagerFactoryBean();</span><br><span class="line">	    contentNegotiationManagerFactoryBean.setFavorParameter(true);</span><br><span class="line">	    contentNegotiationManagerFactoryBean.setIgnoreAcceptHeader(true);</span><br><span class="line">	    contentNegotiationManagerFactoryBean.setDefaultContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line">	    Properties mediaTypesProperties = new Properties();</span><br><span class="line">	    mediaTypesProperties.setProperty(&quot;json&quot;, MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">	    contentNegotiationManagerFactoryBean.setMediaTypes(mediaTypesProperties);</span><br><span class="line">	    contentNegotiationManagerFactoryBean.afterPropertiesSet();</span><br><span class="line">		return contentNegotiationManagerFactoryBean.getObject();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Bean</span><br><span class="line">	public ContentNegotiatingViewResolver contentNegotiatingViewResolver(@Autowired ContentNegotiationManager mvcContentNegotiationManager) &#123;</span><br><span class="line">		ContentNegotiatingViewResolver contentNegotiatingViewResolver = new ContentNegotiatingViewResolver();</span><br><span class="line">		contentNegotiatingViewResolver.setOrder(1);</span><br><span class="line">		contentNegotiatingViewResolver.setContentNegotiationManager(mvcContentNegotiationManager);</span><br><span class="line">		return contentNegotiatingViewResolver;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 采用UTF-8编码，防止中文乱码</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public StringHttpMessageConverter stringHttpMessageConverter() &#123;</span><br><span class="line">		return new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Bean</span><br><span class="line">	public RequestMappingHandlerAdapter requestMappingHandlerAdapter(@Autowired StringHttpMessageConverter stringHttpMessageConverter) &#123;</span><br><span class="line">		RequestMappingHandlerAdapter requestMappingHandlerAdapter = new RequestMappingHandlerAdapter();</span><br><span class="line">		requestMappingHandlerAdapter.setMessageConverters(Collections.singletonList(stringHttpMessageConverter));</span><br><span class="line">		return requestMappingHandlerAdapter;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 设置欢迎页</span><br><span class="line">	 * 相当于web.xml中的 welcome-file-list &gt; welcome-file</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	public void addViewControllers(ViewControllerRegistry registry) &#123;</span><br><span class="line">		registry.addRedirectViewController(&quot;/&quot;, &quot;/index.html&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="编写登录认证Api"><a href="#编写登录认证Api" class="headerlink" title="编写登录认证Api"></a>编写登录认证Api</h1><p>这里在 <code>init</code> 方法中初始化几个用户，放入 <code>USER_DATA</code> 集合，用于后续模拟登录。然后初始化 <code>jedis</code> 连接信息。<code>init</code> 方法被 <code>@PostConstruct</code> 注解，因此 <code>Spring</code> 创建该类的对象后，将自动执行其 <code>init</code> 方法，进行初始化操作。<br>然后看 <code>login</code> 方法，首先根据用户名获取最近 <code>MAX_DISABLED_SECONDS</code> 秒内失败的次数，是否超过最大限制 <code>MAX_TRY_COUNT</code>。</p>
<p>若超过最大限制，不再对用户名和密码进行认证，直接返回认证失败提示信息，也即账户已被锁定的提示信息。</p>
<p>否则，进行用户认证。</p>
<p>若认证失败，将其添加到 Redis 缓存中，并设置过期默认为 <code>MAX_DISABLED_SECONDS</code>，表示从此刻起，<code>MAX_DISABLED_SECONDS</code> 秒内，该用户已登录失败 <code>count</code> 次。</p>
<p>若Redis缓存中已存在该用户认证失败的计数信息，则刷新 <code>count</code> 值，并将旧值的剩余存活时间设置到新值上，然后返回认证失败提示信息。</p>
<p>否则，返回认证成功提示信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xueliang.loginsecuritybyredis.web.controller.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.xueliang.loginsecuritybyredis.web.model.JSONResponse;</span><br><span class="line"><span class="keyword">import</span> org.xueliang.loginsecuritybyredis.web.model.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XueLiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2016年11月1日 下午4:11:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/auth/"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, User&gt; USER_DATA = <span class="keyword">new</span> HashMap&lt;String, User&gt;();</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;auth.max_try_count&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> MAX_TRY_COUNT = <span class="number">0</span>;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;auth.max_disabled_seconds&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> MAX_DISABLED_SECONDS = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;redis.host&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String host;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;redis.port&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> Jedis jedis;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">			String username = <span class="string">"username"</span> + <span class="number">0</span>;</span><br><span class="line">			String password = <span class="string">"password"</span> + <span class="number">0</span>;</span><br><span class="line">			USER_DATA.put(username + <span class="string">"_"</span> + password, <span class="keyword">new</span> User(username, <span class="string">"nickname"</span> + i));</span><br><span class="line">		&#125;</span><br><span class="line">		jedis = <span class="keyword">new</span> Jedis(host, port);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"login"</span>&#125;, method = RequestMethod.POST)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(@RequestParam(<span class="string">"username"</span>)</span> String username, @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span> String password) </span>&#123;</span><br><span class="line">		JSONResponse jsonResponse = <span class="keyword">new</span> JSONResponse();</span><br><span class="line">		String key = username;</span><br><span class="line">		String countString = jedis.get(key);</span><br><span class="line">		<span class="keyword">boolean</span> exists = countString != <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">int</span> count = exists ? Integer.parseInt(countString) : <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (count &gt;= MAX_TRY_COUNT) &#123;</span><br><span class="line">			checkoutMessage(key, count, jsonResponse);</span><br><span class="line">			<span class="keyword">return</span> jsonResponse.toString();</span><br><span class="line">		&#125;</span><br><span class="line">		User user = USER_DATA.get(username + <span class="string">"_"</span> + password);</span><br><span class="line">		<span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">			count++;</span><br><span class="line">			<span class="keyword">int</span> secondsRemain = MAX_DISABLED_SECONDS;</span><br><span class="line">			<span class="keyword">if</span> (exists &amp;&amp; count &lt; <span class="number">5</span>) &#123;</span><br><span class="line">				secondsRemain = (<span class="keyword">int</span>)(jedis.pttl(key) / <span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			jedis.set(key, count + <span class="string">""</span>);</span><br><span class="line">			jedis.expire(key, secondsRemain);</span><br><span class="line">			checkoutMessage(key, count, jsonResponse);</span><br><span class="line">			<span class="keyword">return</span> jsonResponse.toString();</span><br><span class="line">		&#125;</span><br><span class="line">		count = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (exists) &#123;</span><br><span class="line">			jedis.del(key);</span><br><span class="line">		&#125;</span><br><span class="line">		checkoutMessage(key, count, jsonResponse);</span><br><span class="line">		<span class="keyword">return</span> jsonResponse.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> count 尝试次数，也可以改为从redis里直接读</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> jsonResponse</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkoutMessage</span><span class="params">(String key, <span class="keyword">int</span> count, JSONResponse jsonResponse)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">			jsonResponse.setCode(<span class="number">0</span>);</span><br><span class="line">			jsonResponse.addMsg(<span class="string">"success"</span>, <span class="string">"恭喜，登录成功！"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		jsonResponse.setCode(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (count &gt;= MAX_TRY_COUNT) &#123;</span><br><span class="line">			<span class="keyword">long</span> pttlSeconds = jedis.pttl(key) / <span class="number">1000</span>;</span><br><span class="line">			<span class="keyword">long</span> hours = pttlSeconds / <span class="number">3600</span>;</span><br><span class="line">			<span class="keyword">long</span> sencondsRemain = pttlSeconds - hours * <span class="number">3600</span>;</span><br><span class="line">			<span class="keyword">long</span> minutes = sencondsRemain / <span class="number">60</span>;</span><br><span class="line">			<span class="keyword">long</span> seconds = sencondsRemain - minutes * <span class="number">60</span>;</span><br><span class="line">			jsonResponse.addError(<span class="string">"login_disabled"</span>, <span class="string">"登录超过"</span> + MAX_TRY_COUNT + <span class="string">"次，请"</span> + hours + <span class="string">"小时"</span> + minutes + <span class="string">"分"</span> + seconds + <span class="string">"秒后再试！"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		jsonResponse.addError(<span class="string">"username_or_password_is_wrong"</span>, <span class="string">"密码错误，您还有 "</span> + (MAX_TRY_COUNT - count) + <span class="string">" 次机会！"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="编写前端页面"><a href="#编写前端页面" class="headerlink" title="编写前端页面"></a>编写前端页面</h1><p>页面很简单，监听表单提交事件，用 ajax 提交表单数据，然后将认证结果显示到 <code>div</code> 中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  span.error &#123;</span><br><span class="line">    color: red;</span><br><span class="line">  &#125;</span><br><span class="line">  span.msg &#123;</span><br><span class="line">    color: green;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">  &lt;label&gt;用户名&lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;</span><br><span class="line">  &lt;label&gt;密码&lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;password&quot;&gt;</span><br><span class="line">  &lt;button type=&quot;submit&quot;&gt;登录&lt;/button&gt;</span><br><span class="line">  &lt;div&gt;&lt;/div&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  (function($) &#123;</span><br><span class="line">    var $ = (selector) =&gt; document.querySelector(selector);</span><br><span class="line">    var xhr = new XMLHttpRequest();</span><br><span class="line">    xhr.onreadystatechange = function() &#123;</span><br><span class="line">      if (this.readyState == 4 &amp;&amp; this.status == 200) &#123;</span><br><span class="line">        var response = JSON.parse(this.responseText);</span><br><span class="line">        var html = &apos;&apos;;</span><br><span class="line">        var msgNode = &apos;&apos;;</span><br><span class="line">        if (response.code != 0) &#123;</span><br><span class="line">          msgNode = &apos;error&apos;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          msgNode = &apos;msg&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        for (var key in response[msgNode]) &#123;</span><br><span class="line">          html += &apos;&lt;span class=&quot;&apos; + msgNode + &apos;&quot;&gt;&apos; + response[msgNode][key] + &apos;&lt;/span&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        $(&apos;div&apos;).innerHTML = html;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var ajax = function(formData) &#123;</span><br><span class="line">      xhr.open(&apos;POST&apos;, &apos;/api/auth/login.json&apos;, true);</span><br><span class="line">      xhr.setRequestHeader(&apos;Content-Type&apos;, &apos;application/x-www-form-urlencoded; charset=UTF-8&apos;); // 将请求头设置为表单方式提交</span><br><span class="line">      xhr.send(formData);</span><br><span class="line">    &#125;</span><br><span class="line">    $(&apos;form&apos;).addEventListener(&apos;submit&apos;, function(event) &#123;</span><br><span class="line">      event.preventDefault();</span><br><span class="line">      var formData = &apos;&apos;;</span><br><span class="line">      for (var elem of [&apos;username&apos;, &apos;password&apos;]) &#123;</span><br><span class="line">        var value = $(&apos;input[name=&quot;&apos; + elem + &apos;&quot;]&apos;).value;</span><br><span class="line">        formData += (elem + &apos;=&apos; + value + &apos;&amp;&apos;);</span><br><span class="line">      &#125;</span><br><span class="line">      ajax(formData);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>最后上下源码地址：<a href="https://github.com/liangzai-cool/loginsecuritybyredis" target="_blank" rel="noopener">https://github.com/liangzai-cool/loginsecuritybyredis</a></p>
<h1 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h1><p>2016年11月29日 更新，代码优化，增加原子操作，<code>org.xueliang.loginsecuritybyredis.web.controller.api.AuthApi#login</code> 函数作如下优化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">    @RequestMapping(value = &#123;&quot;login&quot;&#125;, method = RequestMethod.POST)</span><br><span class="line">    public String login(@RequestParam(&quot;username&quot;) String username, @RequestParam(&quot;password&quot;) String password) &#123;</span><br><span class="line">        JSONResponse jsonResponse = new JSONResponse();</span><br><span class="line">        String key = username;</span><br><span class="line">        String countString = jedis.get(key);</span><br><span class="line">        boolean exists = countString != null;</span><br><span class="line">        int count = exists ? Integer.parseInt(countString) : 0;</span><br><span class="line">        if (count &gt;= MAX_TRY_COUNT) &#123;</span><br><span class="line">            checkoutMessage(key, count, jsonResponse);</span><br><span class="line">            return jsonResponse.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        User user = USER_DATA.get(username + &quot;_&quot; + password);</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            count++;</span><br><span class="line">//            int secondsRemain = MAX_DISABLED_SECONDS;</span><br><span class="line">//            if (exists &amp;&amp; count &lt; 5) &#123;</span><br><span class="line">//                secondsRemain = (int)(jedis.pttl(key) / 1000);</span><br><span class="line">//            &#125;</span><br><span class="line">//            jedis.set(key, count + &quot;&quot;);</span><br><span class="line">//            jedis.expire(key, secondsRemain);</span><br><span class="line">            if (exists) &#123;</span><br><span class="line">                jedis.incr(key);</span><br><span class="line">                if (count &gt;= MAX_TRY_COUNT) &#123;</span><br><span class="line">                    jedis.expire(key, MAX_DISABLED_SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                jedis.set(key, count + &quot;&quot;);</span><br><span class="line">                jedis.expire(key, MAX_DISABLED_SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            checkoutMessage(key, count, jsonResponse);</span><br><span class="line">            return jsonResponse.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        count = 0;</span><br><span class="line">        if (exists) &#123;</span><br><span class="line">            jedis.del(key);</span><br><span class="line">        &#125;</span><br><span class="line">        checkoutMessage(key, count, jsonResponse);</span><br><span class="line">        return jsonResponse.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h1><ul>
<li><a href="20170302232815082">Spring MVC + Security 4 初体验（Java配置版）</a></li>
<li><a href="20170116145848852">Java程序通过代理访问网络</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/10/11/解决CenOS-7下启动ActiveMQ时报错/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/11/解决CenOS-7下启动ActiveMQ时报错/" itemprop="url">
                  解决CenOS 7下启动ActiveMQ时报错
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-11 18:43:06" itemprop="dateCreated datePublished" datetime="2016-10-11T18:43:06+08:00">2016-10-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 22:59:11" itemprop="dateModified" datetime="2018-12-01T22:59:11+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/11/解决CenOS-7下启动ActiveMQ时报错/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/11/解决CenOS-7下启动ActiveMQ时报错/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/10/11/解决CenOS-7下启动ActiveMQ时报错/" class="leancloud_visitors" data-flag-title="解决CenOS 7下启动ActiveMQ时报错">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>基于 CentOS 7，ActiveMQ 5.9.1</p>
</blockquote>
<h1 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h1><p>在 CentOS 7 下安装好ActiveMQ后，执行 <code>/usr/local/apache-activemq-5.9.1/bin/activemq start</code> 启动 ActiveMQ，显示：</p>
<blockquote>
<p>INFO: Using default configuration<br>(you can configure options in one of these file: /etc/default/activemq /home/xueliang/.activemqrc)</p>
</blockquote>
<blockquote>
<p>INFO: Invoke the following command to create a configuration file<br>/usr/local/apache-activemq-5.9.1/bin/activemq setup [ /etc/default/activemq | /home/xueliang/.activemqrc ]</p>
</blockquote>
<blockquote>
<p>INFO: Using java ‘/usr/local/java/jdk1.8.0_101/bin/java’<br>INFO: Starting - inspect logfiles specified in logging.properties and log4j.properties to get details<br>INFO: pidfile created : ‘/usr/local/apache-activemq-5.9.1/data/activemq-server2.pid’ (pid ‘24484’)</p>
</blockquote>
<p>从提示信息看，似乎启动成功，但根据提示信息中的 <code>pid</code> 查找进程时，却发现并无此进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -eLf | grep 24484</span><br></pre></td></tr></table></figure></p>
<p>结果：</p>
<blockquote>
<p>[xueliang@server2 ~]\$ ps -eLf | grep 24484<br>xueliang 24520 23462 24520  0    1 00:52 pts/2    00:00:00 grep –color=auto 24484<br>[xueliang@server2 ~]\$</p>
</blockquote>
<h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>一个好的软件，总能在错误发生时告诉你如何解决。<br>执行 <code>cat /usr/local/apache-activemq-5.9.1/data/activemq.log</code> 看一下日志信息：</p>
<blockquote>
<p>2016-10-12 02:04:09,053 | INFO  | Refreshing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:09 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:04:10,498 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] started | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:04:10,512 | INFO  | Using Persistence Adapter: KahaDBPersistenceAdapter[/usr/local/apache-activemq-5.9.1/data/kahadb] | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:10,683 | INFO  | KahaDB is version 5 | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:10,746 | INFO  | Recovering from the journal … | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:10,757 | INFO  | Recovery replayed 332 operations from the journal in 0.071 seconds. | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:10,955 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-35685-1476209050769-0:1) is starting | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:10,969 | ERROR | Failed to start Apache ActiveMQ ([localhost, ID:server2-35685-1476209050769-0:1], java.io.IOException: Transport Connector could not be registered in JMX: Failed to bind to server socket: tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 due to: java.net.BindException: Address already in use) | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:10,970 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-35685-1476209050769-0:1) is shutting down | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:10,970 | INFO  | Connector openwire stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:10,970 | INFO  | Connector amqp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:10,970 | INFO  | Connector stomp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:10,970 | INFO  | Connector mqtt stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:10,970 | INFO  | Connector ws stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:10,973 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] stopped | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:04:10,973 | INFO  | Stopping async queue tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:10,973 | INFO  | Stopping async topic tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:10,974 | INFO  | Stopped KahaDB | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:11,193 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-35685-1476209050769-0:1) uptime 0.691 seconds | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:11,193 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-35685-1476209050769-0:1) is shutdown | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:11,193 | INFO  | Closing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:09 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:04:11,194 | WARN  | Exception thrown from LifecycleProcessor on context close | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>java.lang.IllegalStateException: LifecycleProcessor not initialized - call ‘refresh’ before invoking lifecycle methods via the context: org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:09 CST 2016]; root of context hierarchy<br>    at org.springframework.context.support.AbstractApplicationContext.getLifecycleProcessor(AbstractApplicationContext.java:360)<br>    at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1057)<br>    at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1010)<br>    at org.apache.activemq.hooks.SpringContextHook.run(SpringContextHook.java:30)<br>    at org.apache.activemq.broker.BrokerService.stop(BrokerService.java:809)<br>    at org.apache.activemq.xbean.XBeanBrokerService.stop(XBeanBrokerService.java:122)<br>    at org.apache.activemq.broker.BrokerService.start(BrokerService.java:601)<br>    at org.apache.activemq.xbean.XBeanBrokerService.afterPropertiesSet(XBeanBrokerService.java:73)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1638)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1579)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1509)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:521)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:458)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory\$1.getObject(AbstractBeanFactory.java:296)<br>    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:223)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:293)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:194)<br>    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:628)<br>    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:932)<br>    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:479)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:64)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:52)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory\$1.<init>(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createApplicationContext(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createBroker(XBeanBrokerFactory.java:67)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:71)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:54)<br>    at org.apache.activemq.console.command.StartCommand.runTask(StartCommand.java:87)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.runTask(ShellCommand.java:150)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.main(ShellCommand.java:104)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.apache.activemq.console.Main.runTaskClass(Main.java:262)<br>    at org.apache.activemq.console.Main.main(Main.java:115)<br>2016-10-12 02:04:30,534 | INFO  | Refreshing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:30 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:04:31,297 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] started | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:04:31,311 | INFO  | Using Persistence Adapter: KahaDBPersistenceAdapter[/usr/local/apache-activemq-5.9.1/data/kahadb] | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,472 | INFO  | KahaDB is version 5 | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:31,530 | INFO  | Recovering from the journal … | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:31,543 | INFO  | Recovery replayed 334 operations from the journal in 0.068 seconds. | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:04:31,680 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-52293-1476209071560-0:1) is starting | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,695 | ERROR | Failed to start Apache ActiveMQ ([localhost, ID:server2-52293-1476209071560-0:1], java.io.IOException: Transport Connector could not be registered in JMX: Failed to bind to server socket: tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 due to: java.net.BindException: Address already in use) | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,695 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-52293-1476209071560-0:1) is shutting down | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,696 | INFO  | Connector openwire stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:31,696 | INFO  | Connector amqp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:31,696 | INFO  | Connector stomp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:31,696 | INFO  | Connector mqtt stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:31,696 | INFO  | Connector ws stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:04:31,699 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] stopped | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:04:31,699 | INFO  | Stopping async queue tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:31,699 | INFO  | Stopping async topic tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:31,700 | INFO  | Stopped KahaDB | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:04:31,984 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-52293-1476209071560-0:1) uptime 0.682 seconds | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,984 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-52293-1476209071560-0:1) is shutdown | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:04:31,984 | INFO  | Closing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:30 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:04:31,985 | WARN  | Exception thrown from LifecycleProcessor on context close | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>java.lang.IllegalStateException: LifecycleProcessor not initialized - call ‘refresh’ before invoking lifecycle methods via the context: org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:04:30 CST 2016]; root of context hierarchy<br>    at org.springframework.context.support.AbstractApplicationContext.getLifecycleProcessor(AbstractApplicationContext.java:360)<br>    at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1057)<br>    at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1010)<br>    at org.apache.activemq.hooks.SpringContextHook.run(SpringContextHook.java:30)<br>    at org.apache.activemq.broker.BrokerService.stop(BrokerService.java:809)<br>    at org.apache.activemq.xbean.XBeanBrokerService.stop(XBeanBrokerService.java:122)<br>    at org.apache.activemq.broker.BrokerService.start(BrokerService.java:601)<br>    at org.apache.activemq.xbean.XBeanBrokerService.afterPropertiesSet(XBeanBrokerService.java:73)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1638)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1579)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1509)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:521)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:458)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory\$1.getObject(AbstractBeanFactory.java:296)<br>    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:223)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:293)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:194)<br>    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:628)<br>    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:932)<br>    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:479)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:64)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:52)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory\$1.<init>(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createApplicationContext(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createBroker(XBeanBrokerFactory.java:67)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:71)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:54)<br>    at org.apache.activemq.console.command.StartCommand.runTask(StartCommand.java:87)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.runTask(ShellCommand.java:150)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.main(ShellCommand.java:104)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.apache.activemq.console.Main.runTaskClass(Main.java:262)<br>    at org.apache.activemq.console.Main.main(Main.java:115)<br>2016-10-12 02:07:32,656 | INFO  | Refreshing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:07:32 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:07:33,326 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] started | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:07:33,343 | INFO  | Using Persistence Adapter: KahaDBPersistenceAdapter[/usr/local/apache-activemq-5.9.1/data/kahadb] | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:33,528 | INFO  | KahaDB is version 5 | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:07:33,587 | INFO  | Recovering from the journal … | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:07:33,602 | INFO  | Recovery replayed 336 operations from the journal in 0.071 seconds. | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 02:07:33,740 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-53098-1476209253622-0:1) is starting | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:33,749 | ERROR | Failed to start Apache ActiveMQ ([localhost, ID:server2-53098-1476209253622-0:1], java.io.IOException: Transport Connector could not be registered in JMX: Failed to bind to server socket: tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 due to: java.net.BindException: Address already in use) | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:33,750 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-53098-1476209253622-0:1) is shutting down | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:33,750 | INFO  | Connector openwire stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:07:33,750 | INFO  | Connector amqp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:07:33,750 | INFO  | Connector stomp stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:07:33,750 | INFO  | Connector mqtt stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:07:33,750 | INFO  | Connector ws stopped | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 02:07:33,752 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] stopped | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 02:07:33,753 | INFO  | Stopping async queue tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:07:33,753 | INFO  | Stopping async topic tasks | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:07:33,753 | INFO  | Stopped KahaDB | org.apache.activemq.store.kahadb.KahaDBStore | main<br>2016-10-12 02:07:34,039 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-53098-1476209253622-0:1) uptime 0.710 seconds | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:34,039 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-53098-1476209253622-0:1) is shutdown | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 02:07:34,040 | INFO  | Closing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:07:32 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 02:07:34,041 | WARN  | Exception thrown from LifecycleProcessor on context close | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>java.lang.IllegalStateException: LifecycleProcessor not initialized - call ‘refresh’ before invoking lifecycle methods via the context: org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 02:07:32 CST 2016]; root of context hierarchy<br>    at org.springframework.context.support.AbstractApplicationContext.getLifecycleProcessor(AbstractApplicationContext.java:360)<br>    at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1057)<br>    at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1010)<br>    at org.apache.activemq.hooks.SpringContextHook.run(SpringContextHook.java:30)<br>    at org.apache.activemq.broker.BrokerService.stop(BrokerService.java:809)<br>    at org.apache.activemq.xbean.XBeanBrokerService.stop(XBeanBrokerService.java:122)<br>    at org.apache.activemq.broker.BrokerService.start(BrokerService.java:601)<br>    at org.apache.activemq.xbean.XBeanBrokerService.afterPropertiesSet(XBeanBrokerService.java:73)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1638)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1579)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1509)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:521)<br>    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:458)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory\$1.getObject(AbstractBeanFactory.java:296)<br>    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:223)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:293)<br>    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:194)<br>    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:628)<br>    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:932)<br>    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:479)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:64)<br>    at org.apache.xbean.spring.context.ResourceXmlApplicationContext.<init>(ResourceXmlApplicationContext.java:52)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory\$1.<init>(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createApplicationContext(XBeanBrokerFactory.java:104)<br>    at org.apache.activemq.xbean.XBeanBrokerFactory.createBroker(XBeanBrokerFactory.java:67)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:71)<br>    at org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:54)<br>    at org.apache.activemq.console.command.StartCommand.runTask(StartCommand.java:87)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.runTask(ShellCommand.java:150)<br>    at org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)<br>    at org.apache.activemq.console.command.ShellCommand.main(ShellCommand.java:104)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>    at java.lang.reflect.Method.invoke(Method.java:498)<br>    at org.apache.activemq.console.Main.runTaskClass(Main.java:262)<br>    at org.apache.activemq.console.Main.main(Main.java:115)</init></init></init></init></init></init></init></init></init></p>
</blockquote>
<p>刚开始把精力留在了最后一个 <code>WARN</code> 处，即：</p>
<blockquote>
<p>2016-10-12 01:08:54,001 | WARN  | Exception thrown from LifecycleProcessor on context close | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>java.lang.IllegalStateException: LifecycleProcessor not initialized - call ‘refresh’ before invoking lifecycle methods via the context: org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 01:08:52 CST 2016]; root of context hierarchy</p>
</blockquote>
<p>Google 了很久，问题并没有解决，其实问题在上面第一个 <code>ERROR</code> 处，即：</p>
<blockquote>
<p>2016-10-12 01:08:53,602 | ERROR | Failed to start Apache ActiveMQ ([localhost, ID:server2-43498-1476205733474-0:1], java.io.IOException: Transport Connector could not be registered in JMX: Failed to bind to server socket: tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 due to: java.net.BindException: Address already in use) | org.apache.activemq.broker.BrokerService | main</p>
</blockquote>
<p>从提示信息中的 <code>due to: java.net.BindException: Address already in use</code> 可以看到是端口 <code>61616</code> 被占用了。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>既然问题找到了，也就知道怎么解决。<br>使用 <code>netstat -anp | grep 61616</code> 查看是哪个程序占用了 <code>61616</code> 端口：</p>
<blockquote>
<p>[xueliang@server2 ~]\$ netstat -anp | grep 61616<br>(Not all processes could be identified, non-owned process info<br> will not be shown, you would have to be root to see it all.)<br>tcp6       0      0 :::61616                :::*                    LISTEN      10738/java<br>[xueliang@server2 ~]\$</p>
</blockquote>
<p>可以看出 <code>PID</code> 是 <code>10738</code>，可以确定的是该进程可以直接执行以下命令终止掉：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill 10738</span><br></pre></td></tr></table></figure></p>
<p>再次执行 <code>netstat -anp | grep 61616</code> 可以看到刚才占用端口程序已经终止运行了。<br>再次启动 ActiveMQ，并查看日志信息：</p>
<blockquote>
<p>[xueliang@server2 ~]\$ cat /usr/local/apache-activemq-5.9.1/data/activemq.log<br>2016-10-12 01:35:56,610 | INFO  | Refreshing org.apache.activemq.xbean.XBeanBrokerFactory\$1@13c78c0b: startup date [Wed Oct 12 01:35:56 CST 2016]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory\$1 | main<br>2016-10-12 01:35:57,423 | INFO  | PListStore:[/usr/local/apache-activemq-5.9.1/data/localhost/tmp_storage] started | org.apache.activemq.store.kahadb.plist.PListStoreImpl | main<br>2016-10-12 01:35:57,436 | INFO  | Using Persistence Adapter: KahaDBPersistenceAdapter[/usr/local/apache-activemq-5.9.1/data/kahadb] | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 01:35:57,593 | INFO  | KahaDB is version 5 | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 01:35:57,716 | INFO  | Recovering from the journal … | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 01:35:57,717 | INFO  | Recovery replayed 1 operations from the journal in 0.121 seconds. | org.apache.activemq.store.kahadb.MessageDatabase | main<br>2016-10-12 01:35:57,844 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-47815-1476207357729-0:1) is starting | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 01:35:57,855 | INFO  | Listening for connections at: tcp://server2:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 | org.apache.activemq.transport.TransportServerThreadSupport | main<br>2016-10-12 01:35:57,855 | INFO  | Connector openwire started | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 01:35:57,857 | INFO  | Listening for connections at: amqp://server2:5672?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 | org.apache.activemq.transport.TransportServerThreadSupport | main<br>2016-10-12 01:35:57,857 | INFO  | Connector amqp started | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 01:35:57,859 | INFO  | Listening for connections at: stomp://server2:61613?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 | org.apache.activemq.transport.TransportServerThreadSupport | main<br>2016-10-12 01:35:57,862 | INFO  | Connector stomp started | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 01:35:57,864 | INFO  | Listening for connections at: mqtt://server2:1883?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 | org.apache.activemq.transport.TransportServerThreadSupport | main<br>2016-10-12 01:35:57,864 | INFO  | Connector mqtt started | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 01:35:58,018 | INFO  | Listening for connections at ws://server2:61614?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600 | org.apache.activemq.transport.ws.WSTransportServer | main<br>2016-10-12 01:35:58,019 | INFO  | Connector ws started | org.apache.activemq.broker.TransportConnector | main<br>2016-10-12 01:35:58,048 | INFO  | Apache ActiveMQ 5.9.1 (localhost, ID:server2-47815-1476207357729-0:1) started | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 01:35:58,048 | INFO  | For help or more information please see: <a href="http://activemq.apache.org" target="_blank" rel="noopener">http://activemq.apache.org</a> | org.apache.activemq.broker.BrokerService | main<br>2016-10-12 01:35:58,536 | INFO  | ActiveMQ WebConsole available at <a href="http://localhost:8161/" target="_blank" rel="noopener">http://localhost:8161/</a> | org.apache.activemq.web.WebConsoleStarter | main<br>2016-10-12 01:35:58,741 | INFO  | Initializing Spring FrameworkServlet ‘dispatcher’ | /admin | main<br>2016-10-12 01:36:01,077 | INFO  | jolokia-agent: No access restrictor found at classpath:/jolokia-access.xml, access to all MBeans is allowed | /api | main<br>[xueliang@server2 ~]\$</p>
</blockquote>
<p>可以看到已经没有了错误信息，ActiveMQ 正常启动。</p>
<h1 id="其他可能导致启动失败的原因"><a href="#其他可能导致启动失败的原因" class="headerlink" title="其他可能导致启动失败的原因"></a>其他可能导致启动失败的原因</h1><p>在查找问题原因的过程中，发现一些其他可能导致 ActiveMQ 启动失败的原因：</p>
<ol>
<li>主机名包含下划线，相关链接：<a href="http://stackoverflow.com/a/21255931/5122380" target="_blank" rel="noopener">http://stackoverflow.com/a/21255931/5122380</a></li>
<li>将 <code>conf/activemq.xml</code> 文件中 <code>transportConnectors/transportConnector</code> <code>uri</code> 属性中的 <code>0.0.0.0</code> 替换成你主机的域名，或者 <code>127.0.0.1</code> ，形如：<blockquote>
<p>&lt;transportConnectors&gt;</p>
<pre><code>    &amp;lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&amp;gt;
    &amp;lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://127.0.0.1:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&amp;gt;
&amp;lt;/transportConnectors&amp;gt;
</code></pre></blockquote>
</li>
</ol>
<p>相关链接：<a href="http://stackoverflow.com/a/25039610/5122380" target="_blank" rel="noopener">http://stackoverflow.com/a/25039610/5122380</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/09/25/WinSCP-中普通用户以-root-身份登录-Linux/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/25/WinSCP-中普通用户以-root-身份登录-Linux/" itemprop="url">
                  WinSCP 中普通用户以 root 身份登录 Linux
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-25 16:33:44" itemprop="dateCreated datePublished" datetime="2016-09-25T16:33:44+08:00">2016-09-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 20:15:43" itemprop="dateModified" datetime="2018-12-01T20:15:43+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/25/WinSCP-中普通用户以-root-身份登录-Linux/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/25/WinSCP-中普通用户以-root-身份登录-Linux/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/09/25/WinSCP-中普通用户以-root-身份登录-Linux/" class="leancloud_visitors" data-flag-title="WinSCP 中普通用户以 root 身份登录 Linux">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>版本说明：Windows 10，CentOS 7，WinSCP 5.7.7 (Build 6257)</p>
</blockquote>
<h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>使用 WinSCP 登录 CentOS 上传文件，使用的是普通用户，且已加入 <code>sudoers</code> ，向 <code>/usr/local</code> 目录上传文件时，提示没有权限。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol>
<li>首先确保你的目标主机的 <code>sshd</code> 服务正在运行</li>
<li>用来在 WinSCP 登录的普通用户已加入 <code>sudoers</code></li>
<li><p>获取 <code>sftp-server</code> 的位置</p>
<ol>
<li><p>从 <code>/etc/ssh/sshd_config</code> 文件中获取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/ssh/sshd_config | grep sftp</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<blockquote>
<p>Subsystem       sftp    /usr/libexec/openssh/sftp-server</p>
</blockquote>
<ol start="2">
<li><p>直接查找：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo updatedb</span><br><span class="line">locate sftp-server</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<blockquote>
<p>/usr/libexec/openssh/sftp-server<br>/usr/share/man/man8/sftp-server.8.gz</p>
</blockquote>
</li>
</ol>
</li>
</ol>
</li>
<li><p>以管理员方式运行 WinSCP，打开对应帐户的<code>Advanced Site Settings</code> 对话框中，选中 <code>Environment</code> → <code>SFTP</code> 节点，在右边的 <code>Protocol options</code> - <code>SFTP server</code> 输入框中，填入 <code>sudo -s /usr/libexec/openssh/sftp-server</code> ，这里的 <code>/usr/libexec/openssh/sftp-server</code> 换成在你的系统中，由第 3 步得到的路径，之后保存。</p>
</li>
<li><p>在 CentOS 中执行 <code>sudo visudo</code> 以编辑 <code>/etc/sudoers</code> 文件</p>
<ol>
<li>找到需要在 WinSCP 登录的账户名配置信息，大概在第 98 行，将：<code>myloginname ALL=(ALL) ALL</code> 改为： <code>myloginname ALL=(ALL) NOPASSWD:  ALL</code> 。这一步的目的是切换为 <code>root</code> 角色时不需要输入密码，因为 WinSCP 只能执行不需要请求用户输入其他信息（比如：密码等）的命令。<br><strong>切记：记得使用完后，将这一行的内容恢复到修改前的样子！</strong></li>
<li>找到 <code>Defaults    requiretty</code> 这一行，在前面加一个 <code>#</code> 号注释掉这一行，这一步的目的是关闭控制终端。</li>
</ol>
</li>
</ol>
<p>到此，即可以 <code>root</code> 角色登录系统啦！</p>
<h1 id="解决方案优化"><a href="#解决方案优化" class="headerlink" title="解决方案优化"></a>解决方案优化</h1><p>也许你担心由于上述解决方案的第 5 步，在切换为 <code>root</code> 时不需要输入密码，会造成系统不安全。<br>确实是这样，如果你系统安全要求较高，我建议你新建一个帐户，专门用于 WinSCP 中以 <code>root</code> 角色登录。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/09/24/MySQL-中-AUTO-INCREMENT-的“坑”/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/MySQL-中-AUTO-INCREMENT-的“坑”/" itemprop="url">
                  MySQL 中 AUTO_INCREMENT 的“坑”
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-24 17:28:06" itemprop="dateCreated datePublished" datetime="2016-09-24T17:28:06+08:00">2016-09-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 22:46:57" itemprop="dateModified" datetime="2018-12-01T22:46:57+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/24/MySQL-中-AUTO-INCREMENT-的“坑”/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/24/MySQL-中-AUTO-INCREMENT-的“坑”/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/09/24/MySQL-中-AUTO-INCREMENT-的“坑”/" class="leancloud_visitors" data-flag-title="MySQL 中 AUTO_INCREMENT 的“坑”">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>基于 MySQL 5.6</p>
</blockquote>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在玩 MySQL 双主复制架构，表里的主键使用自增ID，为了避免两台主库生成的主键冲突，遂两台主库分别配置如下：<br><code>server 1</code> 的 <code>my.cnf</code> ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_increment_increment = 2</span><br><span class="line">auto_increment_offset = 1</span><br></pre></td></tr></table></figure></p>
<p><code>server 2</code> 的 <code>my.cnf</code> ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_increment_increment = 2</span><br><span class="line">auto_increment_offset = 2</span><br></pre></td></tr></table></figure></p>
<p>按照这个配置，本以为 <code>server 1</code> 和 <code>server 2</code> 生成序列分别是 <code>1</code> ，<code>3</code> ，<code>5</code> ··· 和 <code>2</code> ， <code>4</code>， <code>6</code> ··· 这样的序列，但事实上并不完全是这样，下面来做个试验。</p>
<h1 id="重现"><a href="#重现" class="headerlink" title="重现"></a>重现</h1><p>基于以上配置，在 <code>server 1</code> 上建表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>))</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4;</span><br></pre></td></tr></table></figure></p>
<p>因为我配置了双主同步，所以此表将被同步到 <code>server 2</code> 上。</p>
<p>执行如下添加语句初始化数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname0'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname2'</span>);</span><br></pre></td></tr></table></figure></p>
<p>数据将被同步到 <code>server 2</code> 上。</p>
<p>在 <code>server 1</code> 上查询此表，可以看到刚才插入的数据：<br>id | name<br>– | –<br>1  | myname0<br>3  | myname1<br>5  | myname2<br>结果如我们所料，<code>id</code> 列呈奇数自增。在 <code>server 2</code> 上查询的结果和上面一样。</p>
<p>接着，在 <code>server 2</code> 上向此表再添加几条数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname4'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`table_name`</span> (<span class="string">`name`</span>) <span class="keyword">VALUES</span> (<span class="string">'myname5'</span>);</span><br></pre></td></tr></table></figure></p>
<p>同样数据，将被同步到 <code>server 1</code> 上。</p>
<p>查询此表，得到的结果：<br>id | name<br>– | –<br>1  | myname0<br>3  | myname1<br>5  | myname2<br>6  | myname3<br>8  | myname4<br>10 | myname5</p>
<p>问题出来了，<code>server 2</code> 分配的序列并不像我们之前期望的那样，从 <code>2</code> 开始的连续偶数，而是跳过 <code>2</code> 和 <code>4</code>，直接从 <code>6</code> 开始。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>研究了很久，翻看 MySQL 官网文档，没有提到会是这样子，Goole 了两天，也都说，自增ID分别是 <code>1</code>、<code>2</code>、<code>3</code> 和 <code>2</code> 、 <code>4</code> 、 <code>6</code> ，并没有对此情况做明确说明。直到我看到 <a href="http://stackoverflow.com/a/35786634" target="_blank" rel="noopener">这位大神的回答</a>。<br>具体的我就不重复了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>总结一下：</p>
<ol>
<li><code>AUTO_INCREMENT</code> 所在的列，必须为整数型数据列</li>
<li><code>AUTO_INCREMENT</code> 所在的列，不能为空</li>
<li><code>AUTO_INCREMENT</code> 所在的列，必须有唯一索引</li>
<li><code>AUTO_INCREMENT</code> 所在的列，值必须大于0</li>
<li><code>AUTO_INCREMENT</code> 所在的列，最大值，受其数据类型及是否为 无符号(<code>Unsigned</code>) 限制，若使用的为 <code>TINYINT(4)</code> 且 为无符号的，则最大值为 255，若继续插入数据，则该列的值保持最大值不变，</li>
<li><code>AUTO_INCREMENT</code> 所在的列，若向其中插入的值，大于所在表当前的 <code>AUTO_INCREMENT</code> 值，则会更新表 <code>AUTO_INCREMENT</code> 值至 <code>current_max_value</code> - (<code>current_max_value</code> - <code>auto_increment_offset</code>) % <code>auto_increment_increment</code> + <code>auto_increment_increment</code> ，即该列的下一个序列值</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/09/19/安装-Windows-10-Centos-7-双系统共存/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/19/安装-Windows-10-Centos-7-双系统共存/" itemprop="url">
                  安装 Windows 10 + Centos 7 双系统共存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-19 06:49:44" itemprop="dateCreated datePublished" datetime="2016-09-19T06:49:44+08:00">2016-09-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 20:16:59" itemprop="dateModified" datetime="2018-12-01T20:16:59+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/19/安装-Windows-10-Centos-7-双系统共存/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/19/安装-Windows-10-Centos-7-双系统共存/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/09/19/安装-Windows-10-Centos-7-双系统共存/" class="leancloud_visitors" data-flag-title="安装 Windows 10 + Centos 7 双系统共存">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一步-准备工作"><a href="#第一步-准备工作" class="headerlink" title="第一步 准备工作"></a>第一步 准备工作</h1><h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>给CentOS 系统单独创建一个分区，具体看空闲硬盘的大小决定。</p>
<ul>
<li>右键桌面上 [我的电脑] 或者 [此电脑] 图标，选择 [管理] → [计算机管理] → [存储] - [磁盘管理]</li>
<li>选择一个空闲空间较大的分区，右键选择 [压缩卷(H)…]</li>
<li>在弹出的对话框中输入需要分配给 CentOS 系统的空间大小，以 MB 为单位</li>
<li>输入完毕后，点击对话框右下角的 [压缩] 按钮执行压缩即可</li>
</ul>
<blockquote>
<p>注意：压缩出的新分区，不要执行 [新建简单卷]，否则稍后 CentOS 不识别，到此步即可</p>
</blockquote>
<h2 id="下载-CentOS-7-系统文件"><a href="#下载-CentOS-7-系统文件" class="headerlink" title="下载 CentOS 7 系统文件"></a>下载 CentOS 7 系统文件</h2><p>到 <a href="https://www.centos.org/download" target="_blank" rel="noopener">CentOS官网</a> 下载 ISO 文件，DVD 版即可。</p>
<h2 id="制作优盘启动盘"><a href="#制作优盘启动盘" class="headerlink" title="制作优盘启动盘"></a>制作优盘启动盘</h2><p>同样很简单：</p>
<ul>
<li>准备一个优盘，备份里面所有你认为不能删的文件，稍后将会格式化此优盘</li>
<li>到 <a href="http://cn.ultraiso.net/xiazai.html" target="_blank" rel="noopener">UltraISO官网</a> 下载软件</li>
<li>安装，我基本是用完就卸载，所以，除了安装路径改下，其他全部默认</li>
<li>运行 UltraISO，选择试用，选择主界面菜单栏里的[文件] → [打开]，选择你刚下载好的 CentOS 7 镜像</li>
<li>选择菜单栏里的 [启动] → [写入硬盘映像]</li>
<li>在弹出框中确认选中的优盘无误，其他选项保持默认，无需修改，直接点击下方的 [写入] 按钮，执行制作优盘启动盘，稍后确认制作成功的提示信息即可</li>
</ul>
<p>准备工作到此结束</p>
<h1 id="第二步-从优盘启动安装"><a href="#第二步-从优盘启动安装" class="headerlink" title="第二步 从优盘启动安装"></a>第二步 从优盘启动安装</h1><h2 id="调整-BIOS-引导顺序"><a href="#调整-BIOS-引导顺序" class="headerlink" title="调整 BIOS 引导顺序"></a>调整 BIOS 引导顺序</h2><ul>
<li>插入刚刚制作的优盘启动盘，重启电脑，开机阶段按 <code>F2</code> 、 <code>F8</code> 或 <code>F12</code> 进入 <code>BIOS</code></li>
<li>切换到 <code>Boot</code> 界面，找到优盘启动项，使用 <code>F5</code> 或 <code>F6</code> 调整其顺序至第一位，即从优盘启动</li>
<li>按 <code>F10</code> 保存并退出 <code>BIOS</code> ，即可从优盘引导启动。</li>
<li><p>稍后进入一个标题为 <code>CentOS 7</code> 的黑白界面：<br><img src="http://image.xueliang.org/Fvhx_yTCms9gODhh1qBr8K6XE4M_" alt="图片加载中..."></p>
<p>同时提示 <code>Press Tab for full configuration options on menu items.</code> 和 <code>Automatic boot in 60 seconds...</code>。</p>
</li>
<li><p>默认选中的是 第一项即 <code>Install CentOS 7</code>，按 <code>Tab</code> 键，下方的提示信息将显示为 <code>vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=CentOS\x207x20x86_64 rd.live.check quiet</code><br><img src="http://image.xueliang.org/Fj2I3qpa7B2s-Fc8SmuUPzj_B54X" alt="图片加载中..."></p>
</li>
<li><p>移动光标，删除 <code>LABEL=CentOS\x207x20x86_64 rd.live.check</code> 这部分，并用 <code>linux dd</code> 替换，最终的内容为 <code>vmlinuz initrd=initrd.img linux dd quiet</code><br><img src="http://image.xueliang.org/FkI_Hy3_BErBapIW3v5Rl1pwqAoQ" alt="图片加载中..."></p>
</li>
<li><p>确认无误后回车，可以看到如下界面<br><img src="http://image.xueliang.org/FjaKVh1f66e4pZwC7kQ_cGAyiPYX" alt="图片加载中..."><br>这里可以看到，界面下方有4列，分别是 <code>DEVICE</code> 、 <code>TYPE</code> 、 <code>LABEL</code> 和 <code>UUID</code>，<code>LABEL</code> 这一列就是驱动器名称，据此找到你的优盘，并记下对应 <code>DEVICE</code> 列的值，一般是 <code>sdb4</code> 。</p>
</li>
<li><p>强制关闭计算机后再开机，回到刚才倒计时那个界面，依旧按 <code>Tab</code> 键，修改启动参数，这次修改为 <code>vmlinuz initrd=initrd.img inst.stage2=hd:/dev/sdb4 rd.live.check quiet</code>，这里的 <code>sdb4</code> 替换成你刚才记下的自己优盘对应的 <code>DEVICE</code> 列的值。<br><img src="http://image.xueliang.org/FlOZkXk_pgvUJZGLSpJoyFSMNa8e" alt="图片加载中..."></p>
</li>
<li><p>确认无误后回车，稍等片刻就可以看到暖暖的界面啦！<br><img src="http://image.xueliang.org/FuOHyUxyrOBufk0As_G0v_DKgNvN" alt="图片加载中..."></p>
</li>
</ul>
<h2 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h2><ul>
<li>上面的系统语言根据需要自行选择（为了防止系统自动生成家目录下有 <code>桌面</code> 、 <code>下载</code> 这类中文名路径，切换路径的时候还要修改输入法，比较麻烦，所以这里我保持默认，即 <code>English</code>），这里主要说下第二步的 <code>INSTALLATION SUMMARY</code>。<br><img src="http://image.xueliang.org/FjtnDD7mvzdlVPbd2OrZXkUEve1N" alt="图片加载中..."></li>
</ul>
<h3 id="选择需要安装的基础软件"><a href="#选择需要安装的基础软件" class="headerlink" title="选择需要安装的基础软件"></a>选择需要安装的基础软件</h3><ul>
<li>点击 <code>SOFTWARE</code> 下的 <code>SOFTWARE SELECTION</code> 选择一些需要安装的基础软件，这里只选择安装一个桌面软件 <code>GNOME Desktop</code> 就够了，选择完成之后点击左上角的 <code>Done</code> 回到 <code>INSTALLATION SUMMARY</code> 主界面。<br><img src="http://image.xueliang.org/FmUOhYxVjGrkv-pj120u4UTuVTP_" alt="图片加载中..."></li>
</ul>
<h3 id="磁盘分区"><a href="#磁盘分区" class="headerlink" title="磁盘分区"></a>磁盘分区</h3><ul>
<li><p>点击 <code>SYSTEM</code> 下的 <code>INSTALLATION DESTINATION</code> 选择安装位置，这里可以看到我们之前压缩出来的那个新分区，以及优盘分区。<br>选中那个新分区，并选中 <code>Other Storage Options</code> → <code>Partitioning</code> 下的 <code>I will configure partitioning</code> 选项，<strong>切记，一定要选中此项，否则整个硬盘的数据都将被删除！！！</strong><br>确认无误后，点击左上角的 <code>Done</code> 。<br><img src="http://image.xueliang.org/FuGJxfnAT1ergaMukBYHgp16D7MO" alt="图片加载中..."></p>
</li>
<li><p>这一步对硬盘进行分区，可以点击 <code>Click here to create them automatically</code> 即可让安装程序自动创建分区，非常方便，也可以点击左下角写有 <code>AVAILABLE SPACE</code> 字样的红色区域上方的 <code>+</code> 按钮手动创建分区。<br><img src="http://image.xueliang.org/FgpZdR4Hjoz9dInVLOtVq4LSS2iV" alt="图片加载中..."><br>选择手动分区的话，要注意单位，这里我选择自动分区。分区完成并且确认无误后，点击左上角的 <code>Done</code> 结束对硬盘的分区操作。下面我讲下手动分区操作步骤。</p>
<p>点击 <code>+</code> 按钮，在弹出的对话框中选择新分区挂载的路径，并输入新分区的大小，这里我们设置新分区的大小为 6 GB，并挂载在 根目录 <code>/</code> 下。点击 <code>Add mount point</code> 保存分区信息。<br><img src="http://image.xueliang.org/FiQgkNTChrbqhsaMp37ZR8rXrv9x" alt="图片加载中..."></p>
<p>此时，可以看到新分区已经出现在左侧栏里了，但分区的单位并不对，默认刚才输入的单位是 <code>MiB</code> 并显示为 <code>KiB</code> ，这里我们修改为 <code>MiB</code> 即可，点击右下角 <code>Update Settings</code> 保存修改后的信息。<br><img src="http://image.xueliang.org/FpcsJGlUTM30zbfJSrRoV9fHR-0w" alt="图片加载中..."><br>以同样的方式添加 <code>swap</code> 等分区，添加完成后，点击左上角的 <code>Done</code> 按钮，完成对磁盘的分区。如果没有给 <code>/boot</code> 进行分区，会在第一次点击 <code>Done</code> 后收到警告信息。可以点击 <code>Click for details</code> 查看警告原因，然后点击 <code>Close</code> 后再次点击一次 <code>Done</code> ；也可以忽略警告信息，再点一次 <code>Done</code> 。<br><img src="http://image.xueliang.org/FnYq9rmFDS5EDr7ecwOW56RUkgYj" alt="图片加载中..."><br>忽略警告信息，点击两次 <code>Done</code> 之后，可以在弹出的对话框中看到，即将对磁盘进行修改的摘要信息，直接点击 <code>Accept Changes</code> ，开始对硬盘执行分区操作。<br><img src="http://image.xueliang.org/FrSrIYtD30rKs7lzikOiGcwSaRXT" alt="图片加载中..."></p>
</li>
<li><p>回到 <code>INSTALLATION SUMMARY</code> 界面，待分区执行完成后， <code>SYSTEM</code> 下的 <code>INSTALLATION DESTINATION</code> 下的黄色感叹号就没有。点击右下角的 <code>Begin Installation</code> 按钮开始安装 <code>CentOS</code> 系统。<br><img src="http://image.xueliang.org/FhzfDo0BumSnSInSTNUe7cZg67BU" alt="图片加载中..."></p>
</li>
</ul>
<h3 id="初始化账户"><a href="#初始化账户" class="headerlink" title="初始化账户"></a>初始化账户</h3><ul>
<li><p>安装进度界面可以看到 <code>USER SETTINGS</code> 下，<code>ROOT PASSWORD</code> 提示需要给 <code>root</code> 账户设置密码（<code>root</code> 账户默认是没有密码的），<code>USER CREATION</code> 提示创建一个普通用户。下面我们按照提示完成对账户的初始化。<br><img src="http://image.xueliang.org/FkNNAEgrzPYngcE2cmjEGpvWFp-Z" alt="图片加载中..."></p>
</li>
<li><p>点击 <code>USER SETTINGS</code> 下的 <code>ROOT PASSWORD</code> ，给 <code>root</code> 账户设置密码。如果设置的密码强度不够，需要点两次 <code>Done</code> 按钮忽略警告信息，完成对 <code>root</code> 账户的初始化。<br><img src="http://image.xueliang.org/FhWdSUS0OdUA8fQxNQbA16-M_ajX" alt="图片加载中..."></p>
</li>
<li><p>完成对 <code>root</code> 账户初始化后，可以看到 <code>USER SETTINGS</code> 下 <code>USER CREATION</code> 的黄色感叹号已经消失了，说明初始化 <code>root</code> 账户的密码后，创建普通账户已经变成一个可选项。<br><img src="http://image.xueliang.org/Fkc3wvolSxIOG3XoBqEe-1tCzKFS" alt="图片加载中..."></p>
<p>  但推荐仍创建一个普通账户，以便平时使用，而非平时直接使用 <code>root</code> 账户，这样可以减少使用过程中的误操作，以及 <code>root</code> 账户密码泄露的风险。点击 <code>USER CREATION</code> ，创建一个新的账户，同样 <code>ROOT PASSWORD</code> 一样，如果密码强度不够，请点击两次 <code>Done</code> 按钮。<br><img src="http://image.xueliang.org/Fky6g2Wg-LuXkq01L0ivILSxHiEK" alt="图片加载中..."></p>
</li>
</ul>
<h2 id="完成安装"><a href="#完成安装" class="headerlink" title="完成安装"></a>完成安装</h2><ul>
<li><p>约15 ~ 30 分钟后，CentOS 7 的安装就大功告成啦。<strong>为了避免重启后再次从优盘启动，可以先拔掉优盘，再点击 <code>Reboot</code> 按钮重启计算机；也可以在重启时进入 <code>BIOS</code> 调整引导顺序，恢复硬盘作为第一引导盘。</strong></p>
<p><img src="http://image.xueliang.org/FluJbwfh7XN7TQROZeCL5_mAF32O" alt="图片加载中..."></p>
</li>
<li><p>开机后会看到一个黑白屏的启动菜单，并且有一个默认选项，屏幕下方有一个 5 秒的倒计时，若 5 秒内没有任何操作，将使用默认选中的内核启动系统，也可以使用上下键进行切换并按回车键，即可使用选中的内核启动系统。这里默认即可。</p>
</li>
</ul>
<h1 id="第三步-找回-Windows-10-启动项"><a href="#第三步-找回-Windows-10-启动项" class="headerlink" title="第三步 找回 Windows 10 启动项"></a>第三步 找回 Windows 10 启动项</h1><p>可能大家都注意到了，上面重启之后，已经无法进入之前的 Windows 10 系统。是的，CentOS 7 不能在安装过程中设置之后的启动项，不像 Ubuntu 那样，在安装 Ubuntu 的过程中，就可以选择启动项，因此这时候就无法进入 Windows 10 了。<br>不过，不用担心，因为 Windows 10 系统的引导信息以及数据都是还在的，我们只需要在 CentOS 7 中找回 Windows 10 的引导信息并添加到启动菜单中就可以了。</p>
<ul>
<li>启动 CentOS 7 并使用事先设定的账户，登录系统。这里我使用的是非 <code>root</code> 账户登录的。</li>
</ul>
<h2 id="安装-ntfs-3g"><a href="#安装-ntfs-3g" class="headerlink" title="安装 ntfs-3g"></a>安装 ntfs-3g</h2><ul>
<li>右键桌面，打开一个终端。执行以下命令安装 <code>ntfs-3g</code>：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ntfs-3g</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>之所以需要安装 <code>ntfs-3g</code> ，是因为 Windows 家族专用的文件系统，CentOS 7 默认不能识别，而要想在 CentOS 7 系统中找回 Windows 10 的引导信息，势必要让 CentOS 7 系统识别 Windows 10 的文件系统，故安装此库。</p>
<h2 id="更新-Grub2-启动菜单，找回-Windows-10"><a href="#更新-Grub2-启动菜单，找回-Windows-10" class="headerlink" title="更新 Grub2 启动菜单，找回 Windows 10"></a>更新 Grub2 启动菜单，找回 Windows 10</h2><ul>
<li>执行以下命令即可找回 Windows 10 引导信息：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这一条命令，是让 <code>grub2</code> 自动扫描磁盘中已经安装的所有系统的引导信息，并将其加入到启动菜单中。重启一下计算机，在上面提过的启动菜单界面，是不是可以看到一个有 <code>Windows</code> 字眼的启动项啦？这就是你的 Windows 10！切换到此项，回车，我 Windows 10 又回来啦！</p>
<h1 id="第四步-修复启动菜单界面-Windows-版本显示错误的问题"><a href="#第四步-修复启动菜单界面-Windows-版本显示错误的问题" class="headerlink" title="第四步 修复启动菜单界面 Windows 版本显示错误的问题"></a>第四步 修复启动菜单界面 Windows 版本显示错误的问题</h1><p>虽然 Windows 10 已经找回，然而，不尽如人意的是，引导 Windows 10 的菜单项上的 Windows 系统的版本并非“Windows 10”，而是“Windows 7”或 “Windows 8.1”等。<br>初步推测，此启动项上显示的 Windows 版本号，取决于你从何版本的 Windows 升级到 Windows 10的（若你是从 Windows 7 升级到 Windows 10 的，那此启动项的文字就会显示“Windows 7”字眼，对于从 Windows 8.1 升级也是一样的道理。未考虑直接安装 Windows 10 的情况）。<br>需要说明的是，这里只是一个文字显示错误，对正常使用没有丝毫影响。但你有强迫症的话，请继续往下看。</p>
<h2 id="修复显示错误"><a href="#修复显示错误" class="headerlink" title="修复显示错误"></a>修复显示错误</h2><p>我已经打好了一个 patch，放到了<a href="https://gist.github.com/liangzai-cool/59f0c29a528305a9aa1c3971aeef604b" target="_blank" rel="noopener">这里</a>了，登录已安装好的 CentOS 7 系统，打开一个终端，并这行以下命令即可：</p>
<ul>
<li><p>下载patch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://gist.githubusercontent.com/liangzai-cool/59f0c29a528305a9aa1c3971aeef604b/raw/316a739240b388ff46ee95d38d2c7a97dcd53cbf/20microsoft-win10.patch</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装patch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((sudo cp 20microsoft-win10.patch / &amp;&amp; cd / &amp;&amp; sudo patch -p0  ) &lt; 20microsoft-win10.patch)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="错误原因浅析"><a href="#错误原因浅析" class="headerlink" title="错误原因浅析"></a>错误原因浅析</h2><ul>
<li>启动菜单是执行 <code>Grub2</code> 的命令后，由 <code>Grub2</code> 生成的</li>
<li><code>Grub2</code> 本身并不能识别磁盘中已安装的操作系统，它是依赖 <code>os-prober</code> 这个库来识别的</li>
<li><code>os-prober</code> 本是为 <code>debian</code> 系统编写的，其在 <code>debian</code> 系统下不能识别 <code>Windows 10</code> 的问题已经修复</li>
<li>CentOS 下的 <code>os-prober</code> 目前最新版本依旧是 <code>1.58</code> ，该版本依旧存在此问题，貌似 CentOS 下的 <code>os-prober</code> 无人维护。问题代码位置是 <code>/usr/libexec/os-probes/mounted/20microsoft</code></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/08/25/Linux下修改系统时区/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/25/Linux下修改系统时区/" itemprop="url">
                  Linux下修改系统时区
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-08-25 04:47:05" itemprop="dateCreated datePublished" datetime="2016-08-25T04:47:05+08:00">2016-08-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 22:46:38" itemprop="dateModified" datetime="2018-12-01T22:46:38+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/25/Linux下修改系统时区/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/25/Linux下修改系统时区/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/25/Linux下修改系统时区/" class="leancloud_visitors" data-flag-title="Linux下修改系统时区">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用-etc-localtime-文件修改时区"><a href="#使用-etc-localtime-文件修改时区" class="headerlink" title="使用 /etc/localtime 文件修改时区"></a>使用 /etc/localtime 文件修改时区</h1><p>先查看一下当前的时区，下面这个例子中使用 <code>UTC</code> 即世界统一标准时区。假设你可能需要改为美国西部标准时间，即太平洋时间。</p>
<blockquote>
<p># date<br>Thu Aug 17 22:59:24 UTC 2016</p>
</blockquote>
<p>在某些发行版的 Linux 系统（比如 <code>CentOS</code>）中，系统时区是由 <code>/etc/localtime</code> 文件控制的，所以可以通过修改 <code>/etc/localtime</code> 文件来修改系统时区。</p>
<p>删除 <code>/etc/localtime</code> 文件，</p>
<blockquote>
<p># cd /etc/<br># rm localtime</p>
</blockquote>
<p>所有的美国时区文件都可以在 <code>/usr/share/zoneinfo/US</code> 目录下找到：</p>
<blockquote>
<p># ls /usr/share/zoneinfo/US/<br>Alaska           Arizona        Eastern            Hawaii               Michigan        Pacific<br>Aleutian        Central         East-Indiana    Indiana-Starke  Mountain        Samoa</p>
</blockquote>
<p>其他国家的时区文件，可以在 <code></code>/usr/share/zoneinfo/` 找到。</p>
<p>创建一个软连接 <code>/etc/localtime</code> ，指向上述 <code>US</code> 目录中的 <code>Pacific</code> 文件：</p>
<blockquote>
<p># cd /etc<br># ln -s /usr/share/zoneinfo/US/Pacific localtime</p>
</blockquote>
<p>到此，已经将系统的时区改为美国西部所在的时区：</p>
<blockquote>
<p># date<br>Thu Aug 17 23:10:14 PDT 2016</p>
</blockquote>
<h1 id="使用-etc-timezone-文件修改时区"><a href="#使用-etc-timezone-文件修改时区" class="headerlink" title="使用 /etc/timezone 文件修改时区"></a>使用 /etc/timezone 文件修改时区</h1><p>在某些发行版的 Linux 系统（比如 <code>Ubuntu</code>）中，系统时区是由 <code>/etc/timezone</code> 文件控制的，所以可以通过修改 <code>/etc/timezone</code> 文件来修改系统时区。</p>
<p>举个例子，你现在的时区可能在美国东部时间（比如：纽约）：</p>
<blockquote>
<p># cat /etc/timezone<br>America/New_York</p>
</blockquote>
<p>需要设置到美国太平洋时间（比如：洛杉矶），修改 <code>/etc/timezone</code> 时间：</p>
<blockquote>
<p># vim /etc/timezone<br>America/Los_Angeles</p>
</blockquote>
<p>当然，也可以通过在命令行上修改 <code>TZ</code> 的值来设置时区：</p>
<blockquote>
<p># export TZ=America/Los_Angeles</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.xueliang.org/2016/08/19/Git如何检出指定目录或文件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="薛亮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="薛亮的主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/19/Git如何检出指定目录或文件/" itemprop="url">
                  Git如何检出指定目录或文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-08-19 11:00:12" itemprop="dateCreated datePublished" datetime="2016-08-19T11:00:12+08:00">2016-08-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-01 19:22:57" itemprop="dateModified" datetime="2018-12-01T19:22:57+08:00">2018-12-01</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/19/Git如何检出指定目录或文件/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/19/Git如何检出指定目录或文件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/08/19/Git如何检出指定目录或文件/" class="leancloud_visitors" data-flag-title="Git如何检出指定目录或文件">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-views-count"></span>
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-user"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读人数：</span>
               
                 <span class="leancloud-visitors-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>系统版本：Window 10，Git 版本：2.7.1</p>
</blockquote>
<p>对于大型 Git 仓库，每次执行 Git 命令，都需要经过漫长的等待，特别是要经常执行的 <code>git status</code> 命令。下面是一个例子…</p>
<p><img src="http://image.xueliang.org/FriKsPuoZMDMfknq6skki_-2QgkS" alt="图片加载中..."></p>
<p>从 1.7.0 开始，Git 引入 <code>sparse checkout（稀疏检出）</code> 机制，稀疏检出机制允许只检出指定目录或者文件，这在大型 Git 仓库中，将大幅度缩短 Git 执行命令的时间。</p>
<p>要想只检出指定的目录或文件，需要在 <code>.git/info/sparse-checkout</code> 文件中指定目录或文件的路径，下面将以一个具体例子介绍 如何使用 Git 的 <code>sparse checkout</code> 。</p>
<h1 id="准备远程仓库"><a href="#准备远程仓库" class="headerlink" title="准备远程仓库"></a>准备远程仓库</h1><p>初始化一个仓库，目录结构如下图所示：</p>
<p><img src="http://image.xueliang.org/FgM1B496NLsod5HmdL2QKmhmSCRY" alt="图片加载中..."></p>
<p>根目录下有 2 个子目录，以及一个     <code>LICENSE</code> 文件和 <code>README.md</code> 文件，每个子目录中各有 3 个。<br>将其推送到Github上新建的一个仓库，地址是 <a href="mailto:`git@github.com" target="_blank" rel="noopener">`git@github.com</a>:liangzai-cool/git-sparse-checkout-study.git` 。</p>
<h1 id="为Git配置稀疏检出"><a href="#为Git配置稀疏检出" class="headerlink" title="为Git配置稀疏检出"></a>为Git配置稀疏检出</h1><p>换一个目录，再初始化一个 Git 仓库，以便用稀疏检出的方式，检出刚才在 Github 上新建的 <code>git-sparse-checkout-study</code> 仓库：</p>
<p><img src="http://image.xueliang.org/FrTXWwD1_W5OZ_zTq4LafjiKJaRB" alt="图片加载中..."></p>
<p>使用 <code>git config core.sparseCheckout true</code> 命令开启 Git 稀疏检出模式。然后编辑该仓库目录下的 <code>.git/info/sparse-checkout</code> 文件，指定检出规则。这里只检出 <code>git-sparse-checkout-study</code> 仓库中的 <code>dir1</code> 目录下的所有文件和 根目录下的 <code>README.md</code> 文件：</p>
<p><img src="http://image.xueliang.org/FqHfvJOlYfBo9yblbkjvABAS_hWq" alt="图片加载中..."></p>
<h1 id="检出"><a href="#检出" class="headerlink" title="检出"></a>检出</h1><p>添加远程仓库地址，并检出：</p>
<p><img src="http://image.xueliang.org/FhPAM924g8GBJxpddtNxKqRbLe4J" alt="图片加载中..."></p>
<p>可以看到，Git 只检出了根目录下的 <code>README.md</code> 文件和 <code>dir1</code> 目录。</p>
<p>如果此时需要再检出，根目录下的 <code>dir2</code> 目录，则需要将其加入到 <code>.git/info/sparse-checkout</code> 文件中。参照下图中的方案：</p>
<p><img src="http://image.xueliang.org/FuDPr3IB4fFcmi3XRSlVm_gYrcUP" alt="图片加载中..."></p>
<h1 id="关闭稀疏检出"><a href="#关闭稀疏检出" class="headerlink" title="关闭稀疏检出"></a>关闭稀疏检出</h1><p>和上面检出 <code>dir2</code> 时类似：</p>
<p><img src="http://image.xueliang.org/FtmRQFcXFI5OSlQQXkB6iQYR8pyt" alt="图片加载中..."></p>
<p>可以看到所有文件都已显示出来了。<br>注意这里的 <code>echo</code> 命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/*&quot; &gt; .git/info/sparse-checkout</span><br></pre></td></tr></table></figure></p>
<p>最后不要忘了配置 Git 的 <code>core.sparseCheckout</code> 为 <code>false</code> 以及移除 <code>.git/info/sparse-checkout</code> 文件。</p>
<p><code>.git/info/sparse-checkout</code> 中使用和 <code>.gitignore</code> 相同的匹配模式，例如 非匹配 <code>!/dir2/*</code> 以及 <code>/*.java</code> 等。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">薛亮</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">45</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; 2015 – <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">薛亮</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xueliang-org.disqus.com/count.js" async></script>
  

  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>

  
  <script>
    
    function showTime(Counter) {
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url: { "$in": entries } }) })
        .done(function ({ results }) {
          var VIEWS_COUNT_CONTAINER_REF = '.leancloud-visitors-views-count';
          var VISITORS_COUNT_CONTAINER_REF = '.leancloud-visitors-visitors-count';

          if (results.length === 0) {
            $visitors.find(VIEWS_COUNT_CONTAINER_REF).text(0);
            $visitors.find(VISITORS_COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var views = item.views;
            var visitors = item.visitors;
            var element = document.getElementById(url);

            $(element).find(VIEWS_COUNT_CONTAINER_REF).text(views);
            $(element).find(VISITORS_COUNT_CONTAINER_REF).text(visitors);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var viewsCountSpan = $(element).find(VIEWS_COUNT_CONTAINER_REF);
            var visitorsCountSpan = $(element).find(VISITORS_COUNT_CONTAINER_REF);
            if( viewsCountSpan.text() == '') {
              viewsCountSpan.text(0);
            }
            if( visitorsCountSpan.text() == '') {
              visitorsCountSpan.text(0);
            }
          }
        })
        .fail(function ({ responseJSON }) {
          console.log("LeanCloud Counter Error: " + responseJSON.code + " " + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "aiuIxrb8ayxV9v2VsOtqGQmH-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "aiuIxrb8ayxV9v2VsOtqGQmH-gzGzoHsz",
                'X-LC-Key': "ETfvPKpVm60Muzk8IV63Gkql",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          if ($('.post-title-link').length >= 1) {
            showTime(Counter);
          }
          
        })
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  

  

  

  

  

  

</body>
</html>
